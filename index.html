<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Financial Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2563eb" />

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
  --bg: #f4f6f9;
  --card: #fff;
  --text: #111827;
  --line: #e5e7eb;
  --accent: #2563eb;
  --soft: #e7f0ff;
  --radius: 8px;
  --success: #059669;
  --danger: #dc2626;
  --warning: #d97706;
  --nav-height: 60px;
}
body.dark {
  --bg: #0d1117;
  --card: #161b22;
  --text: #e6edf3;
  --line: #30363d;
  --soft: #1f2937;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
  line-height: 1.5;
  font-size: 14px;
  padding-bottom: var(--nav-height);
}
.page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px;
  background: var(--card);
  min-height: calc(100vh - var(--nav-height));
}

/* Header */
.header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--line);
  position: relative;
}
h1 { margin: 0 0 8px 0; font-weight: 600; font-size: 24px; }
.subtitle { color: var(--text); opacity: 0.7; margin: 0; font-size: 14px; }

/* Controls */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
  align-items: center;
}
button {
  background: var(--accent);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
button:hover { opacity: 0.9; transform: translateY(-1px); }
button:active { transform: translateY(0); }
button.secondary { background: #4b5563; }
button.danger { background: var(--danger); }
button.success { background: var(--success); }
button.warning { background: var(--warning); }

/* Salary Input */
.salary-input {
  background: var(--soft);
  padding: 16px;
  border-radius: var(--radius);
  margin-bottom: 20px;
}
.salary-input label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 15px; }
.salary-input input {
  width: 100%;
  max-width: 300px;
  padding: 10px 14px;
  border-radius: var(--radius);
  border: 1px solid var(--line);
  background: var(--card);
  color: var(--text);
  font-size: 16px;
}
.salary-input input:focus { outline: 2px solid var(--accent); border-color: transparent; }

/* Month Sections */
.month-section {
  background: var(--bg);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 20px;
  border: 1px solid var(--line);
  display: none;
}
.month-section.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.month-header {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--line);
}
@media (min-width: 768px) {
  .month-header { flex-direction: row; justify-content: space-between; align-items: center; }
}
.month-header input {
  font-size: 20px;
  font-weight: 600;
  background: transparent;
  border: none;
  color: var(--text);
  padding: 8px;
  border-radius: 4px;
  width: 100%;
  max-width: 300px;
}
.month-header input:focus { outline: 2px solid var(--accent); background: var(--card); }
.month-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* Tables */
.table-section { margin-bottom: 24px; }
.table-section h3 {
  margin: 0 0 12px 0;
  font-weight: 500;
  font-size: 16px;
  color: var(--text);
  opacity: 0.9;
  display: flex;
  align-items: center;
  gap: 8px;
}
.table-container {
  overflow-x: auto;
  border-radius: var(--radius);
  border: 1px solid var(--line);
  margin-bottom: 12px;
  -webkit-overflow-scrolling: touch;
}
table { width: 100%; border-collapse: collapse; min-width: 900px; }
thead { background: var(--soft); }
th {
  padding: 12px 8px;
  text-align: left;
  font-weight: 500;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text);
  opacity: 0.7;
  border-bottom: 1px solid var(--line);
  white-space: nowrap;
}
td {
  padding: 12px 8px;
  border-bottom: 1px solid var(--line);
  background: var(--card);
  vertical-align: middle;
}
tbody tr:hover td { background: var(--soft); }
tbody tr:last-child td { border-bottom: none; }

/* Form Elements */
input, select {
  width: 100%;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid var(--line);
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  box-sizing: border-box;
  min-height: 40px;
}
input:focus, select:focus { outline: 2px solid var(--accent); border-color: transparent; }

.radio-group { display: flex; gap: 12px; flex-wrap: wrap; }
.radio-group label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; white-space: nowrap; }
input[type="radio"] { width: auto; margin: 0; min-height: auto; }

.paid-status { min-width: 150px; }
.actions { white-space: nowrap; min-width: 60px; }
.delete-btn {
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  padding: 8px;
  border-radius: 4px;
  font-size: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
}
.delete-btn:hover { background: rgba(220, 38, 38, 0.1); }

/* Summary */
.summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid var(--line);
}
.summary-item { background: var(--soft); padding: 16px; border-radius: var(--radius); text-align: center; }
.summary-item span { display: block; font-size: 13px; opacity: 0.7; margin-bottom: 8px; font-weight: 500; }
.summary-item b { font-size: 20px; font-weight: 600; }

/* Dark toggle */
.dark-toggle {
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 1000;
  background: var(--accent);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}
.modal {
  background: var(--card);
  border-radius: var(--radius);
  width: 100%;
  max-width: 560px;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.modal-header {
  padding: 20px;
  border-bottom: 1px solid var(--line);
  display: flex;
  align-items: center;
  gap: 12px;
}
.modal-header h3 { margin: 0; flex: 1; font-size: 18px; }
.modal-close {
  background: none;
  border: none;
  color: var(--text);
  cursor: pointer;
  padding: 8px;
  border-radius: 4px;
  font-size: 20px;
}
.modal-close:hover { background: var(--soft); }
.modal-content { padding: 20px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 20px; border-top: 1px solid var(--line); display: flex; gap: 8px; justify-content: flex-end; }

/* Lists manager */
.methods-list { margin: 0; padding: 0; list-style: none; }
.method-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  border-radius: var(--radius);
  margin-bottom: 8px;
  background: var(--soft);
}
.method-item input { flex: 1; margin: 0; }
.add-method-form { display: flex; gap: 10px; margin-top: 14px; }
.add-method-form input { flex: 1; margin: 0; }

/* Loading + notifications */
.loading {
  display: none;
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: var(--bg);
  z-index: 3000;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: var(--text);
}
.loading.active { display: flex; }
.notification {
  position: fixed;
  bottom: calc(var(--nav-height) + 20px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--danger);
  color: white;
  padding: 12px 20px;
  border-radius: var(--radius);
  z-index: 1001;
  display: none;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.notification.show { display: flex; animation: slideUp 0.3s ease; }
@keyframes slideUp {
  from { transform: translateX(-50%) translateY(100px); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

/* Pagination */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin: 20px 0;
  padding: 10px;
  border-top: 1px solid var(--line);
}
.pagination-btn {
  padding: 8px 16px;
  background: var(--soft);
  color: var(--text);
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 14px;
}
.pagination-btn:hover:not(:disabled) { background: var(--accent); color: white; }
.pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.pagination-info { font-size: 14px; opacity: 0.7; }

/* Bottom nav */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: var(--nav-height);
  background: var(--card);
  border-top: 1px solid var(--line);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 1000;
  padding: 0 10px;
}
.nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  background: none;
  border: none;
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 12px;
  opacity: 0.7;
  transition: all 0.2s;
  flex: 1;
  max-width: 120px;
}
.nav-btn:hover { opacity: 1; background: var(--soft); }
.nav-btn.active { opacity: 1; color: var(--accent); background: var(--soft); }
.nav-icon { font-size: 20px; }

/* Reports */
.reports-page { display: none; }
.reports-page.active { display: block; }
.report-card {
  background: var(--soft);
  padding: 20px;
  border-radius: var(--radius);
  margin-bottom: 16px;
  cursor: pointer;
  transition: all 0.2s;
}
.report-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.report-card h3 { margin: 0 0 8px 0; font-size: 16px; }
.report-card p { margin: 0; opacity: 0.7; font-size: 13px; }

.help-text { font-size: 12px; opacity: 0.6; margin-top: 4px; display: block; }

.last-saved {
  font-size: 12px;
  opacity: 0.7;
  margin-left: auto;
  padding: 4px 8px;
  background: var(--soft);
  border-radius: 4px;
  display: none;
}
@media (min-width: 768px) { .last-saved { display: block; } }

.empty-state {
  text-align: center;
  padding: 40px 20px;
  opacity: 0.6;
}
@media (max-width: 768px) {
  .page { padding: 12px; }
  .controls { flex-direction: column; align-items: stretch; }
  .controls button { width: 100%; justify-content: center; }
  .salary-input input { max-width: 100%; }
  .month-actions { width: 100%; }
  .month-actions button { flex: 1; min-width: 0; }
  .summary { grid-template-columns: 1fr; }
}
</style>
</head>

<body>
<button class="dark-toggle" onclick="toggleDarkMode()">üåô Dark</button>

<div class="loading" id="loading">Loading your data...</div>
<div class="notification" id="notification"></div>

<!-- Home Page -->
<div id="home-page" class="page">
  <div class="header">
    <h1>Financial Tracker</h1>
    <p class="subtitle">Core Bills ‚Ä¢ Overdraft Tracking ‚Ä¢ BNPL ‚Ä¢ Finance Plans ‚Ä¢ Debt</p>
  </div>

  <div class="salary-input">
    <label for="salary">Monthly Salary (¬£)</label>
    <input id="salary" type="number" value="0" min="0" step="0.01" oninput="saveAll()" placeholder="Enter your monthly salary" />
  </div>

  <div class="controls">
    <button onclick="addMonth()">üìÖ Add Month</button>
    <button class="secondary" onclick="openListManager(LIST_KEYS.methods)">‚öô Manage Methods</button>
    <button class="secondary" onclick="openListManager(LIST_KEYS.coreTypes)">‚öô Manage Core Types</button>
    <button class="secondary" onclick="openListManager(LIST_KEYS.debtTypes)">‚öô Manage Debt Types</button>
    <button class="success" onclick="exportPDF()">üìÑ Export PDF</button>
    <button class="secondary" onclick="exportAllCSV()">üìä Export All CSV</button>
    <button class="secondary" onclick="showBackupManager()">üíæ Backup</button>
    <div class="last-saved" id="last-saved">Ready</div>
  </div>

  <div id="months-container">
    <div class="empty-state" id="empty-state">
      <h3>No months added yet</h3>
      <p>Click "Add Month" to start tracking your finances</p>
    </div>
  </div>

  <div class="pagination" id="pagination" style="display:none;">
    <button class="pagination-btn" onclick="prevMonth()" id="prev-btn">‚Üê Previous</button>
    <div class="pagination-info" id="page-info">Month 1 of 1</div>
    <button class="pagination-btn" onclick="nextMonth()" id="next-btn">Next ‚Üí</button>
  </div>
</div>

<!-- Reports Page -->
<div id="reports-page" class="page reports-page">
  <div class="header">
    <h1>Reports & Analytics</h1>
    <p class="subtitle">View insights and trends from your financial data</p>
  </div>

  <div class="report-card" onclick="showMonthlySummaryReport()">
    <h3>üìä Monthly Summary</h3>
    <p>Overview of all months with totals and comparisons</p>
  </div>

  <div class="report-card" onclick="showCategoryBreakdown()">
    <h3>üìà Category Breakdown</h3>
    <p>Analysis of spending by core bill type</p>
  </div>

  <div class="report-card" onclick="showPaymentMethodAnalysis()">
    <h3>üí≥ Payment Method Analysis</h3>
    <p>See which payment methods you use most frequently</p>
  </div>

  <div class="report-card" onclick="showDebtOverview()">
    <h3>üìâ Debt & Overdraft Overview</h3>
    <p>Track your debt, overdraft, and finance plan balances</p>
  </div>

  <div class="report-card" onclick="showYearlyTrends()">
    <h3>üìÖ Yearly Trends</h3>
    <p>View your financial patterns over time</p>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <button class="nav-btn active" id="nav-home" onclick="showPage('home')">
    <span class="nav-icon">üè†</span><span>Home</span>
  </button>
  <button class="nav-btn" id="nav-reports" onclick="showPage('reports')">
    <span class="nav-icon">üìä</span><span>Reports</span>
  </button>
</div>

<script>
/* =========================================================
   Globals + Storage Keys
========================================================= */
window.jsPDF = window.jspdf?.jsPDF;

const STORAGE = {
  data: "fin_tracker_data_v2",
  lists: "fin_tracker_lists_v2",
  dark: "darkMode"
};

const LIST_KEYS = {
  methods: "methods",
  coreTypes: "coreTypes",
  debtTypes: "debtTypes"
};

let currentMonthIndex = 0;
let monthsData = [];
let listManagerOverlay = null;

window.lists = {
  [LIST_KEYS.methods]: [],
  [LIST_KEYS.coreTypes]: [],
  [LIST_KEYS.debtTypes]: []
};

function uid(prefix="id") {
  return `${prefix}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
}

/* =========================================================
   Notifications + Loading
========================================================= */
function showNotification(message, type="info") {
  const n = document.getElementById("notification");
  n.textContent = message;
  n.className = "notification show";

  if (type === "error") n.style.background = "var(--danger)";
  else if (type === "success") n.style.background = "var(--success)";
  else n.style.background = "var(--accent)";

  setTimeout(() => { n.className = "notification"; }, 3000);
}

function showLoading(show) {
  document.getElementById("loading").style.display = show ? "flex" : "none";
}

function updateLastSaved(message) {
  const el = document.getElementById("last-saved");
  if (message) el.textContent = message;
  else {
    const now = new Date();
    el.textContent = `Saved: ${now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`;
  }
}

/* =========================================================
   Lists (Dropdown options) - Save/Load + Manager Modal
========================================================= */
function getDefaultLists() {
  return {
    [LIST_KEYS.methods]: [
      "Cash","Debit Card","Credit Card","Bank Transfer","Direct Debit",
      "Standing Order","PayPal","Apple Pay","Google Pay","Other"
    ],
    [LIST_KEYS.coreTypes]: [
      "Utility","Rent/Mortgage","Insurance","Subscription","Loan","Other"
    ],
    [LIST_KEYS.debtTypes]: [
      "Overdraft","BNPL","Finance Plan","Debt"
    ]
  };
}

function loadLists() {
  const saved = localStorage.getItem(STORAGE.lists);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      const defs = getDefaultLists();
      window.lists[LIST_KEYS.methods] = Array.isArray(parsed?.[LIST_KEYS.methods]) && parsed[LIST_KEYS.methods].length ? parsed[LIST_KEYS.methods] : defs[LIST_KEYS.methods];
      window.lists[LIST_KEYS.coreTypes] = Array.isArray(parsed?.[LIST_KEYS.coreTypes]) && parsed[LIST_KEYS.coreTypes].length ? parsed[LIST_KEYS.coreTypes] : defs[LIST_KEYS.coreTypes];
      window.lists[LIST_KEYS.debtTypes] = Array.isArray(parsed?.[LIST_KEYS.debtTypes]) && parsed[LIST_KEYS.debtTypes].length ? parsed[LIST_KEYS.debtTypes] : defs[LIST_KEYS.debtTypes];
      return;
    } catch {}
  }
  const defs = getDefaultLists();
  window.lists = { ...defs };
  saveLists();
}

function saveLists() {
  localStorage.setItem(STORAGE.lists, JSON.stringify(window.lists));
}

function listTitle(key) {
  if (key === LIST_KEYS.methods) return "Payment Methods";
  if (key === LIST_KEYS.coreTypes) return "Core Bill Types";
  if (key === LIST_KEYS.debtTypes) return "Debt/Overdraft Types";
  return "Options";
}

function openListManager(key) {
  closeListManager();

  const title = listTitle(key);
  const items = window.lists[key] || [];

  const html = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="closeListManager()">‚Üê</button>
        <h3>Manage: ${title}</h3>
        <button class="modal-close" onclick="closeListManager()">√ó</button>
      </div>
      <div class="modal-content">
        <p style="margin-top:0;opacity:.7;font-size:14px;">
          Add, edit, or remove options. These update ALL dropdowns.
        </p>

        <div id="list-manager-container">
          ${items.map((v, idx) => `
            <div class="method-item">
              <input type="text" value="${escapeHtml(v)}" oninput="updateListItem('${key}', ${idx}, this.value)" placeholder="Option name" />
              <button class="delete-btn" style="font-size:14px;" onclick="removeListItem('${key}', ${idx})">Remove</button>
            </div>
          `).join("")}
        </div>

        <div class="add-method-form">
          <input type="text" id="list-new-input" placeholder="New option" onkeypress="if(event.key==='Enter') addListItem('${key}')"/>
          <button class="success" onclick="addListItem('${key}')">Add</button>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeListManager()">Close</button>
        <button class="success" onclick="saveListManager('${key}')">Save & Close</button>
      </div>
    </div>
  `;

  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = html;
  overlay.onclick = (e) => { if (e.target === overlay) closeListManager(); };
  document.body.appendChild(overlay);
  listManagerOverlay = overlay;

  setTimeout(() => document.getElementById("list-new-input")?.focus(), 80);
}

function closeListManager() {
  if (listManagerOverlay) {
    listManagerOverlay.remove();
    listManagerOverlay = null;
  }
}

function saveListManager(key) {
  // Clean: trim + drop empty + unique
  const cleaned = (window.lists[key] || [])
    .map(x => (x || "").trim())
    .filter(Boolean);
  window.lists[key] = Array.from(new Set(cleaned));
  saveLists();
  renderAllDynamicDropdowns();
  saveAll();
  closeListManager();
  showNotification("Options saved", "success");
}

function updateListItem(key, index, value) {
  if (!Array.isArray(window.lists[key])) window.lists[key] = [];
  window.lists[key][index] = value;
}

function removeListItem(key, index) {
  if (!Array.isArray(window.lists[key])) return;
  if (window.lists[key].length <= 1) {
    showNotification("You must keep at least one option.", "error");
    return;
  }
  window.lists[key].splice(index, 1);

  // re-render within modal
  if (listManagerOverlay) openListManager(key);
}

function addListItem(key) {
  const input = document.getElementById("list-new-input");
  const value = (input?.value || "").trim();
  if (!value) return;

  const arr = window.lists[key] || [];
  if (arr.map(x => (x||"").trim().toLowerCase()).includes(value.toLowerCase())) {
    showNotification("This option already exists.", "error");
    return;
  }

  arr.push(value);
  window.lists[key] = arr;
  input.value = "";
  openListManager(key);
}

/* =========================================================
   Safe HTML
========================================================= */
function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================================================
   App Init + Data Load
========================================================= */
function initApp() {
  showLoading(true);

  try {
    // Dark mode
    const dm = localStorage.getItem(STORAGE.dark);
    if (dm === "true") {
      document.body.classList.add("dark");
      document.querySelector(".dark-toggle").textContent = "‚òÄÔ∏è Light";
    }

    // Lists
    loadLists();

    // Data
    const saved = localStorage.getItem(STORAGE.data);
    if (saved) {
      try {
        const data = JSON.parse(saved);
        if (data.salary != null) document.getElementById("salary").value = data.salary;
        if (Array.isArray(data.months)) monthsData = data.months;
      } catch (e) {
        console.error("Error parsing saved data:", e);
        showNotification("Error loading saved data. Starting fresh.", "error");
        monthsData = [];
      }
    }

    if (monthsData.length > 0) {
      currentMonthIndex = Math.min(currentMonthIndex, monthsData.length - 1);
      renderCurrentMonth();
      document.getElementById("pagination").style.display = "flex";
      document.getElementById("empty-state").style.display = "none";
    } else {
      document.getElementById("empty-state").style.display = "block";
      document.getElementById("pagination").style.display = "none";
    }

    updateLastSaved("Ready");
  } catch (e) {
    console.error(e);
    showNotification("Error loading app. Please refresh.", "error");
  } finally {
    setTimeout(() => showLoading(false), 400);
  }
}

/* =========================================================
   Dropdown builders (methods + types) with Manage option
========================================================= */
function getSelectHTML(key, current="") {
  const options = (window.lists[key] || []);
  const manageVal = `__manage__${key}`;

  return `
    <select data-dynamic-select="1" data-list-key="${key}" onchange="handleDynamicSelectChange(this)">
      <option value=""></option>
      ${options.map(o => {
        const val = escapeHtml(o);
        const sel = (o === current) ? "selected" : "";
        return `<option value="${val}" ${sel}>${val}</option>`;
      }).join("")}
      <option value="${manageVal}">‚öô Manage...</option>
    </select>
  `;
}

function handleDynamicSelectChange(select) {
  const key = select.getAttribute("data-list-key");
  const val = select.value;

  if (val && val.startsWith("__manage__")) {
    select.value = "";
    openListManager(key);
    return;
  }
  saveAll();
}

function renderAllDynamicDropdowns() {
  // Rebuild every dynamic select while preserving current value
  document.querySelectorAll('select[data-dynamic-select="1"]').forEach(sel => {
    const key = sel.getAttribute("data-list-key");
    const current = sel.value;
    sel.outerHTML = getSelectHTML(key, current);
  });
}

/* =========================================================
   Row Templates (fix radio group collisions with unique name)
========================================================= */
function ensureRowId(obj) {
  if (!obj) obj = {};
  if (!obj._rid) obj._rid = uid("row");
  return obj;
}

function getPaidRadioGroup(rowId, paidValue="not-paid") {
  const name = `paid_${rowId}`;
  const paidChecked = paidValue === "paid" ? "checked" : "";
  const notPaidChecked = paidValue !== "paid" ? "checked" : "";
  return `
    <div class="radio-group" data-paid-group="${escapeHtml(name)}">
      <label><input type="radio" name="${escapeHtml(name)}" value="paid" ${paidChecked} onchange="saveAll()"> Paid</label>
      <label><input type="radio" name="${escapeHtml(name)}" value="not-paid" ${notPaidChecked} onchange="saveAll()"> Not Paid</label>
    </div>
  `;
}

function getCoreBillsRow(data = {}) {
  data = ensureRowId(data);
  return `
    <tr data-rid="${escapeHtml(data._rid)}">
      <td><input type="date" class="date-input" value="${escapeHtml(data.date || "")}" oninput="saveAll()"></td>
      <td>${getSelectHTML(LIST_KEYS.methods, data.method || "")}</td>
      <td><input type="text" class="company-input" value="${escapeHtml(data.company || "")}" placeholder="Company" oninput="saveAll()"></td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.amount ?? "0")}" class="amount-input" oninput="saveAll()"></td>
      <td>${getSelectHTML(LIST_KEYS.coreTypes, data.type || "")}</td>
      <td class="paid-status">${getPaidRadioGroup(data._rid, data.paid || "not-paid")}</td>
      <td class="actions"><button class="delete-btn" onclick="deleteRow(this)" title="Delete row">‚úï</button></td>
    </tr>
  `;
}

function getOverdraftRow(data = {}) {
  data = ensureRowId(data);
  return `
    <tr data-rid="${escapeHtml(data._rid)}">
      <td><input type="date" class="date-input" value="${escapeHtml(data.date || "")}" oninput="saveAll()"></td>
      <td>${getSelectHTML(LIST_KEYS.methods, data.method || "")}</td>
      <td><input type="text" class="company-input" value="${escapeHtml(data.company || "")}" placeholder="Bank/Company" oninput="saveAll()"></td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.amount ?? "0")}" class="amount-input" oninput="saveAll()"></td>
      <td>${getSelectHTML(LIST_KEYS.debtTypes, data.type || "")}</td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.currentBalance || "")}" class="current-balance" placeholder="Current Balance" oninput="saveAll()"></td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.outstandingBalance || "")}" class="outstanding-balance" placeholder="Outstanding Balance" oninput="saveAll()"></td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.limit || "")}" class="limit-input" placeholder="Limit" oninput="saveAll()"></td>
      <td class="paid-status">${getPaidRadioGroup(data._rid, data.paid || "not-paid")}</td>
      <td class="actions"><button class="delete-btn" onclick="deleteRow(this)" title="Delete row">‚úï</button></td>
    </tr>
  `;
}

/* =========================================================
   Month Rendering + Pagination
========================================================= */
function createMonthElement(monthData) {
  const div = document.createElement("div");
  div.className = "month-section";
  div.id = monthData.id || uid("month");

  const coreRows = (Array.isArray(monthData.coreBills) && monthData.coreBills.length)
    ? monthData.coreBills.map(b => getCoreBillsRow(b)).join("")
    : getCoreBillsRow();

  const debtRows = (Array.isArray(monthData.overdraftEntries) && monthData.overdraftEntries.length)
    ? monthData.overdraftEntries.map(e => getOverdraftRow(e)).join("")
    : getOverdraftRow();

  div.innerHTML = `
    <div class="month-header">
      <input type="text" class="month-name" value="${escapeHtml(monthData.name || "New Month")}" oninput="saveAll()">
      <div class="month-actions">
        <button class="warning" onclick="clearMonth(${currentMonthIndex})">üóëÔ∏è Clear</button>
        <button class="secondary" onclick="exportMonthCSV(${currentMonthIndex})">üìä CSV</button>
        <button class="danger" onclick="deleteMonth(${currentMonthIndex})">üóëÔ∏è Delete</button>
      </div>
    </div>

    <div class="table-section">
      <h3>üìã Core Bills</h3>
      <div class="table-container">
        <table id="core-bills-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Method</th>
              <th>Company</th>
              <th>Amount (¬£)</th>
              <th>Type</th>
              <th>Paid</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${coreRows}</tbody>
        </table>
      </div>
      <button class="secondary" onclick="addCoreBillsRow(this)" style="margin-top: 8px;">+ Add Bill</button>
    </div>

    <div class="table-section">
      <h3>üí≥ Overdraft Tracking, BNPL, Finance Plan, Debt Tracking</h3>
      <div class="table-container">
        <table id="overdraft-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Method</th>
              <th>Bank/Company</th>
              <th>Amount (¬£)</th>
              <th>Type</th>
              <th>Current Balance</th>
              <th>Outstanding</th>
              <th>Limit</th>
              <th>Paid</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${debtRows}</tbody>
        </table>
      </div>
      <button class="secondary" onclick="addOverdraftRow(this)" style="margin-top: 8px;">+ Add Entry</button>
      <span class="help-text">Overdraft: Current Balance = current amount, Outstanding = remaining, Limit = max allowed</span>
    </div>

    <div class="summary">
      <div class="summary-item"><span>Total Core Bills</span><b class="core-total">¬£0.00</b></div>
      <div class="summary-item"><span>Total Overdraft/Debt</span><b class="overdraft-total">¬£0.00</b></div>
      <div class="summary-item"><span>Remaining Salary</span><b class="remaining-salary">¬£0.00</b></div>
    </div>
  `;
  return div;
}

function renderCurrentMonth() {
  const container = document.getElementById("months-container");

  if (monthsData.length === 0) {
    container.innerHTML = `
      <div class="empty-state" id="empty-state">
        <h3>No months added yet</h3>
        <p>Click "Add Month" to start tracking your finances</p>
      </div>
    `;
    document.getElementById("pagination").style.display = "none";
    return;
  }

  document.getElementById("empty-state")?.style && (document.getElementById("empty-state").style.display = "none");
  document.getElementById("pagination").style.display = "flex";

  container.innerHTML = "";
  const monthData = monthsData[currentMonthIndex];
  const monthEl = createMonthElement(monthData);
  monthEl.classList.add("active");
  container.appendChild(monthEl);

  updateAll();
  updatePagination();
}

function updatePagination() {
  const pageInfo = document.getElementById("page-info");
  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");
  pageInfo.textContent = `Month ${currentMonthIndex + 1} of ${monthsData.length}`;
  prevBtn.disabled = currentMonthIndex === 0;
  nextBtn.disabled = currentMonthIndex === monthsData.length - 1;
}

function prevMonth() {
  if (currentMonthIndex > 0) {
    saveCurrentMonthData();
    currentMonthIndex--;
    renderCurrentMonth();
  }
}

function nextMonth() {
  if (currentMonthIndex < monthsData.length - 1) {
    saveCurrentMonthData();
    currentMonthIndex++;
    renderCurrentMonth();
  }
}

/* =========================================================
   Save/Load Month Data (from DOM)
========================================================= */
function getPaidValueFromRow(row) {
  const rid = row.getAttribute("data-rid");
  const name = `paid_${rid}`;
  const checked = row.querySelector(`input[name="${CSS.escape(name)}"]:checked`);
  return checked ? checked.value : "not-paid";
}

function saveCurrentMonthData() {
  const monthEl = document.querySelector(".month-section.active");
  if (!monthEl || !monthsData[currentMonthIndex]) return;

  const monthData = {
    id: monthEl.id,
    name: monthEl.querySelector(".month-name")?.value || "New Month",
    coreBills: [],
    overdraftEntries: []
  };

  monthEl.querySelectorAll("#core-bills-table tbody tr").forEach(row => {
    const rid = row.getAttribute("data-rid") || uid("row");
    monthData.coreBills.push({
      _rid: rid,
      date: row.querySelector(".date-input")?.value || "",
      method: row.querySelector(`select[data-list-key="${CSS.escape(LIST_KEYS.methods)}"]`)?.value || "",
      company: row.querySelector(".company-input")?.value || "",
      amount: row.querySelector(".amount-input")?.value || "0",
      type: row.querySelector(`select[data-list-key="${CSS.escape(LIST_KEYS.coreTypes)}"]`)?.value || "",
      paid: getPaidValueFromRow(row)
    });
  });

  monthEl.querySelectorAll("#overdraft-table tbody tr").forEach(row => {
    const rid = row.getAttribute("data-rid") || uid("row");
    monthData.overdraftEntries.push({
      _rid: rid,
      date: row.querySelector(".date-input")?.value || "",
      method: row.querySelector(`select[data-list-key="${CSS.escape(LIST_KEYS.methods)}"]`)?.value || "",
      company: row.querySelector(".company-input")?.value || "",
      amount: row.querySelector(".amount-input")?.value || "0",
      type: row.querySelector(`select[data-list-key="${CSS.escape(LIST_KEYS.debtTypes)}"]`)?.value || "",
      currentBalance: row.querySelector(".current-balance")?.value || "",
      outstandingBalance: row.querySelector(".outstanding-balance")?.value || "",
      limit: row.querySelector(".limit-input")?.value || "",
      paid: getPaidValueFromRow(row)
    });
  });

  monthsData[currentMonthIndex] = monthData;
}

function saveAll() {
  try {
    saveCurrentMonthData();

    const payload = {
      version: 2,
      salary: document.getElementById("salary").value || "0",
      months: monthsData,
      lastSaved: new Date().toISOString()
    };

    localStorage.setItem(STORAGE.data, JSON.stringify(payload));
    updateAll();
    updateLastSaved();
  } catch (e) {
    console.error("saveAll error:", e);
    showNotification("Error saving data", "error");
  }
}

/* =========================================================
   Row Operations
========================================================= */
function addCoreBillsRow(button) {
  const tbody = button.previousElementSibling.querySelector("tbody");
  tbody.insertAdjacentHTML("beforeend", getCoreBillsRow());
  saveAll();
}

function addOverdraftRow(button) {
  const tbody = button.previousElementSibling.querySelector("tbody");
  tbody.insertAdjacentHTML("beforeend", getOverdraftRow());
  saveAll();
}

function deleteRow(button) {
  const row = button.closest("tr");
  if (!row) return;
  const tbody = row.parentElement;
  if (tbody.children.length <= 1) {
    showNotification("Cannot delete the last row. Clear the month instead.", "error");
    return;
  }
  row.remove();
  saveAll();
}

/* =========================================================
   Month Operations
========================================================= */
function addMonth() {
  saveCurrentMonthData();
  const monthName = new Date().toLocaleDateString("en-US", { month: "long", year: "numeric" });

  monthsData.push({
    id: uid("month"),
    name: monthName,
    coreBills: [],
    overdraftEntries: []
  });

  currentMonthIndex = monthsData.length - 1;
  renderCurrentMonth();
  document.getElementById("empty-state").style.display = "none";
  document.getElementById("pagination").style.display = "flex";
  saveAll();
  showNotification("Month added successfully", "success");
}

function clearMonth(index) {
  if (!monthsData[index]) return;
  if (!confirm("Clear all data in this month? This cannot be undone.")) return;

  monthsData[index].coreBills = [];
  monthsData[index].overdraftEntries = [];
  renderCurrentMonth();
  saveAll();
  showNotification("Month cleared", "success");
}

function deleteMonth(index) {
  if (!confirm("Delete this entire month? This cannot be undone.")) return;
  monthsData.splice(index, 1);

  if (currentMonthIndex >= monthsData.length) currentMonthIndex = Math.max(0, monthsData.length - 1);

  if (monthsData.length === 0) {
    document.getElementById("months-container").innerHTML = `
      <div class="empty-state" id="empty-state">
        <h3>No months added yet</h3>
        <p>Click "Add Month" to start tracking your finances</p>
      </div>
    `;
    document.getElementById("pagination").style.display = "none";
  } else {
    renderCurrentMonth();
  }

  saveAll();
  showNotification("Month deleted", "success");
}

/* =========================================================
   Calculations
========================================================= */
function calculateMonthTotals(monthEl) {
  let coreTotal = 0;
  let overdraftTotal = 0;

  monthEl.querySelectorAll("#core-bills-table tbody tr").forEach(row => {
    const v = parseFloat(row.querySelector(".amount-input")?.value || "0") || 0;
    coreTotal += v;
  });

  monthEl.querySelectorAll("#overdraft-table tbody tr").forEach(row => {
    const v = parseFloat(row.querySelector(".amount-input")?.value || "0") || 0;
    overdraftTotal += v;
  });

  const salary = parseFloat(document.getElementById("salary").value || "0") || 0;
  const remaining = salary - coreTotal - overdraftTotal;

  monthEl.querySelector(".core-total").textContent = `¬£${coreTotal.toFixed(2)}`;
  monthEl.querySelector(".overdraft-total").textContent = `¬£${overdraftTotal.toFixed(2)}`;
  monthEl.querySelector(".remaining-salary").textContent = `¬£${remaining.toFixed(2)}`;
}

function updateAll() {
  const monthEl = document.querySelector(".month-section.active");
  if (monthEl) calculateMonthTotals(monthEl);
}

/* =========================================================
   Navigation
========================================================= */
function showPage(page) {
  const homeBtn = document.getElementById("nav-home");
  const reportsBtn = document.getElementById("nav-reports");
  const homePage = document.getElementById("home-page");
  const reportsPage = document.getElementById("reports-page");

  if (page === "home") {
    homeBtn.classList.add("active");
    reportsBtn.classList.remove("active");
    homePage.style.display = "block";
    reportsPage.classList.remove("active");
  } else {
    homeBtn.classList.remove("active");
    reportsBtn.classList.add("active");
    homePage.style.display = "none";
    reportsPage.classList.add("active");
  }
}

/* =========================================================
   Reports (same as your originals, adjusted to new lists)
========================================================= */
function showMonthlySummaryReport() {
  if (monthsData.length === 0) { showNotification("No data available for reports", "error"); return; }

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üìä Monthly Summary Report</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">${generateMonthlySummaryHTML()}</div>
      <div class="modal-footer">
        <button class="success" onclick="exportPDF()">Export PDF</button>
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function generateMonthlySummaryHTML() {
  const salary = parseFloat(document.getElementById("salary").value || "0") || 0;
  return monthsData.map(m => {
    const coreTotal = (m.coreBills || []).reduce((s, b) => s + (parseFloat(b.amount || 0) || 0), 0);
    const debtTotal = (m.overdraftEntries || []).reduce((s, e) => s + (parseFloat(e.amount || 0) || 0), 0);
    const remaining = salary - coreTotal - debtTotal;
    return `
      <div style="margin-bottom:18px;">
        <h4 style="margin:0 0 10px 0;">${escapeHtml(m.name || "Month")}</h4>
        <div class="summary" style="margin:0;">
          <div class="summary-item"><span>Core Bills</span><b>¬£${coreTotal.toFixed(2)}</b></div>
          <div class="summary-item"><span>Overdraft/Debt</span><b>¬£${debtTotal.toFixed(2)}</b></div>
          <div class="summary-item"><span>Remaining</span><b style="color:${remaining >= 0 ? "var(--success)" : "var(--danger)"}">¬£${remaining.toFixed(2)}</b></div>
        </div>
      </div>
    `;
  }).join("");
}

function showCategoryBreakdown() {
  if (monthsData.length === 0) { showNotification("No data available for reports", "error"); return; }

  const categories = {};
  monthsData.forEach(m => {
    (m.coreBills || []).forEach(b => {
      const type = b.type || "Uncategorized";
      const amt = parseFloat(b.amount || 0) || 0;
      categories[type] = (categories[type] || 0) + amt;
    });
  });

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üìà Category Breakdown</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        ${Object.entries(categories).sort((a,b)=>b[1]-a[1]).map(([cat,total]) => `
          <div style="margin-bottom:10px;padding:10px;background:var(--soft);border-radius:var(--radius);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span>${escapeHtml(cat)}</span><b>¬£${total.toFixed(2)}</b>
            </div>
          </div>
        `).join("")}
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function showPaymentMethodAnalysis() {
  if (monthsData.length === 0) { showNotification("No data available for reports", "error"); return; }

  const methods = {};
  monthsData.forEach(m => {
    (m.coreBills || []).forEach(b => {
      const k = b.method || "Not specified";
      methods[k] = (methods[k] || 0) + (parseFloat(b.amount || 0) || 0);
    });
    (m.overdraftEntries || []).forEach(e => {
      const k = e.method || "Not specified";
      methods[k] = (methods[k] || 0) + (parseFloat(e.amount || 0) || 0);
    });
  });

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üí≥ Payment Method Analysis</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        ${Object.entries(methods).sort((a,b)=>b[1]-a[1]).map(([m,total]) => `
          <div style="margin-bottom:10px;padding:10px;background:var(--soft);border-radius:var(--radius);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span>${escapeHtml(m)}</span><b>¬£${total.toFixed(2)}</b>
            </div>
          </div>
        `).join("")}
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function showDebtOverview() {
  if (monthsData.length === 0) { showNotification("No data available for reports", "error"); return; }

  let totals = { Debt:0, Overdraft:0, BNPL:0, "Finance Plan":0 };
  monthsData.forEach(m => {
    (m.overdraftEntries || []).forEach(e => {
      const t = e.type || "";
      const amt = parseFloat(e.amount || 0) || 0;
      if (totals[t] != null) totals[t] += amt;
    });
  });

  const grand = Object.values(totals).reduce((s,v)=>s+v,0);

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üìâ Debt & Overdraft Overview</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        <div style="margin-bottom:15px;padding:15px;background:var(--soft);border-radius:var(--radius);">
          ${Object.entries(totals).map(([k,v])=>`
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <span>${escapeHtml(k)}</span>
              <b style="color:${k==="Debt" ? "var(--danger)" : "var(--warning)"}">¬£${v.toFixed(2)}</b>
            </div>
          `).join("")}
        </div>
        <div class="help-text" style="text-align:center;">Total Outstanding: ¬£${grand.toFixed(2)}</div>
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function showYearlyTrends() {
  if (monthsData.length === 0) { showNotification("No data available for reports", "error"); return; }

  const years = {};
  monthsData.forEach(m => {
    const match = (m.name || "").match(/\d{4}/);
    if (!match) return;
    const y = match[0];
    if (!years[y]) years[y] = { core:0, debt:0, count:0 };

    const coreTotal = (m.coreBills || []).reduce((s,b)=>s+(parseFloat(b.amount||0)||0),0);
    const debtTotal = (m.overdraftEntries || []).reduce((s,e)=>s+(parseFloat(e.amount||0)||0),0);

    years[y].core += coreTotal;
    years[y].debt += debtTotal;
    years[y].count++;
  });

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üìÖ Yearly Trends</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        ${Object.entries(years).map(([y,d])=>`
          <div style="margin-bottom:15px;padding:15px;background:var(--soft);border-radius:var(--radius);">
            <h4 style="margin:0 0 10px 0;">${y} (${d.count} months)</h4>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span>Average Core Bills:</span><b>¬£${(d.core/d.count).toFixed(2)}/month</b>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span>Average Debt/Overdraft:</span><b>¬£${(d.debt/d.count).toFixed(2)}/month</b>
            </div>
          </div>
        `).join("")}
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

/* =========================================================
   Dark Mode
========================================================= */
function toggleDarkMode() {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  document.querySelector(".dark-toggle").textContent = isDark ? "‚òÄÔ∏è Light" : "üåô Dark";
  localStorage.setItem(STORAGE.dark, String(isDark));
}

/* =========================================================
   Backup & Restore (FIXED + backwards compatible)
========================================================= */
function showBackupManager() {
  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>Backup & Restore</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        <p style="margin-top:0;opacity:.7;font-size:14px;">Backup your data or restore from a backup file</p>

        <div style="margin-bottom: 20px;">
          <h4 style="margin:0 0 10px 0;">Backup Data</h4>
          <p style="margin:0 0 10px 0;opacity:.7;font-size:13px;">Download a backup of all your financial data</p>
          <button class="success" onclick="downloadBackup()" style="width:100%;">üì• Download Backup</button>
        </div>

        <div>
          <h4 style="margin:0 0 10px 0;">Restore Data</h4>
          <p style="margin:0 0 10px 0;opacity:.7;font-size:13px;">Upload a backup file to restore your data</p>
          <input type="file" id="restore-file" accept=".json,application/json" style="margin-bottom:10px;padding:8px;">
          <button class="secondary" onclick="restoreBackup()" style="width:100%;">üì§ Restore from Backup</button>
          <p style="margin:10px 0 0 0;font-size:12px;opacity:.6;color:var(--danger);">Warning: This will replace all current data!</p>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function safeParseJSON(text) {
  const cleaned = String(text || "").replace(/^\uFEFF/, "").trim(); // strip BOM
  return JSON.parse(cleaned);
}

function normalizeBackup(raw) {
  let b = raw;

  // allow wrappers
  if (b && typeof b === "object") {
    if (b.data && typeof b.data === "object") b = b.data;
    if (b.backup && typeof b.backup === "object") b = b.backup;
  }

  const months =
    (b && Array.isArray(b.months) && b.months) ||
    (raw?.data && Array.isArray(raw.data.months) && raw.data.months) ||
    (raw?.backup && Array.isArray(raw.backup.months) && raw.backup.months) ||
    null;

  if (!months) throw new Error("Invalid backup: months array not found");

  const salary = (b && b.salary != null) ? b.salary : "0";

  // new v2 backups
  const lists = (b && b.lists && typeof b.lists === "object") ? b.lists : null;

  // old backups: paymentMethods
  const paymentMethods = (b && Array.isArray(b.paymentMethods)) ? b.paymentMethods : null;

  const darkMode = (b && typeof b.darkMode === "boolean") ? b.darkMode : null;

  return { salary, months, lists, paymentMethods, darkMode };
}

function downloadBackup() {
  try { saveAll(); } catch {}

  const backup = {
    version: 2,
    exported: new Date().toISOString(),
    salary: document.getElementById("salary").value || "0",
    months: monthsData,
    lists: {
      methods: window.lists[LIST_KEYS.methods] || [],
      coreTypes: window.lists[LIST_KEYS.coreTypes] || [],
      debtTypes: window.lists[LIST_KEYS.debtTypes] || []
    },
    darkMode: document.body.classList.contains("dark")
  };

  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `financial-tracker-backup-${new Date().toISOString().split("T")[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showNotification("Backup downloaded successfully", "success");
  document.querySelector(".modal-overlay")?.remove();
}

function restoreBackup() {
  const fileInput = document.getElementById("restore-file");
  const file = fileInput?.files?.[0];

  if (!file) {
    showNotification("Please select a backup file", "error");
    return;
  }

  const reader = new FileReader();

  reader.onload = (e) => {
    try {
      const raw = safeParseJSON(e.target.result);
      const normalized = normalizeBackup(raw);

      if (!confirm("Restore backup? This will replace all current data.")) return;

      // salary
      document.getElementById("salary").value = normalized.salary ?? "0";

      // lists
      if (normalized.lists) {
        if (Array.isArray(normalized.lists.methods) && normalized.lists.methods.length) window.lists[LIST_KEYS.methods] = normalized.lists.methods;
        if (Array.isArray(normalized.lists.coreTypes) && normalized.lists.coreTypes.length) window.lists[LIST_KEYS.coreTypes] = normalized.lists.coreTypes;
        if (Array.isArray(normalized.lists.debtTypes) && normalized.lists.debtTypes.length) window.lists[LIST_KEYS.debtTypes] = normalized.lists.debtTypes;
      }
      // old backups
      if (normalized.paymentMethods && normalized.paymentMethods.length) {
        window.lists[LIST_KEYS.methods] = normalized.paymentMethods;
      }
      saveLists();

      // months normalized
      monthsData = normalized.months.map(m => ({
        id: m.id || uid("month"),
        name: m.name || "New Month",
        coreBills: Array.isArray(m.coreBills) ? m.coreBills.map(ensureRowId) : [],
        overdraftEntries: Array.isArray(m.overdraftEntries) ? m.overdraftEntries.map(ensureRowId) : []
      }));

      currentMonthIndex = 0;

      // dark mode
      if (typeof normalized.darkMode === "boolean") {
        document.body.classList.toggle("dark", normalized.darkMode);
        document.querySelector(".dark-toggle").textContent = normalized.darkMode ? "‚òÄÔ∏è Light" : "üåô Dark";
        localStorage.setItem(STORAGE.dark, String(normalized.darkMode));
      }

      renderCurrentMonth();
      saveAll();

      showNotification("Backup restored successfully", "success");
      document.querySelector(".modal-overlay")?.remove();
    } catch (err) {
      console.error("restoreBackup error:", err);
      showNotification("Error restoring backup. Invalid file format.", "error");
    }
  };

  reader.onerror = () => showNotification("Could not read the file. Try again.", "error");
  reader.readAsText(file);
}

/* =========================================================
   CSV Export
========================================================= */
function downloadCSV(data, filename) {
  const blob = new Blob([data], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function exportMonthCSV(index) {
  saveAll();
  const month = monthsData[index];
  if (!month) return;

  let csv = [];
  csv.push("Core Bills");
  csv.push("Date,Payment Method,Company,Amount,Payment Type,Paid Status");
  (month.coreBills || []).forEach(b => {
    csv.push([b.date,b.method,b.company,b.amount,b.type,b.paid].map(c => `"${String(c ?? "").replaceAll('"','""')}"`).join(","));
  });

  csv.push("", "");
  csv.push("Overdraft, BNPL, Finance Plan, Debt Tracking");
  csv.push("Date,Payment Method,Bank/Company,Amount,Payment Type,Current Balance,Outstanding Balance,Limit,Paid Status");
  (month.overdraftEntries || []).forEach(e => {
    csv.push([e.date,e.method,e.company,e.amount,e.type,e.currentBalance,e.outstandingBalance,e.limit,e.paid].map(c => `"${String(c ?? "").replaceAll('"','""')}"`).join(","));
  });

  downloadCSV(csv.join("\n"), `${(month.name || "month").replace(/[^a-z0-9]/gi,"_")}_${new Date().toISOString().split("T")[0]}.csv`);
  showNotification("CSV exported successfully", "success");
}

function exportAllCSV() {
  saveAll();
  if (monthsData.length === 0) { showNotification("No data to export", "error"); return; }

  let csv = [];
  csv.push("Financial Tracker - All Data");
  csv.push(`Generated: ${new Date().toLocaleString()}`);
  csv.push(`Salary: ¬£${document.getElementById("salary").value || "0"}`);
  csv.push("");

  monthsData.forEach(month => {
    csv.push(`Month: ${month.name || "Month"}`);
    csv.push("==================================================");

    if ((month.coreBills || []).length) {
      csv.push("Core Bills");
      csv.push("Date,Payment Method,Company,Amount,Payment Type,Paid Status");
      month.coreBills.forEach(b => {
        csv.push([b.date,b.method,b.company,b.amount,b.type,b.paid].map(c => `"${String(c ?? "").replaceAll('"','""')}"`).join(","));
      });
      csv.push("");
    }

    if ((month.overdraftEntries || []).length) {
      csv.push("Overdraft, BNPL, Finance Plan, Debt Tracking");
      csv.push("Date,Payment Method,Bank/Company,Amount,Payment Type,Current Balance,Outstanding Balance,Limit,Paid Status");
      month.overdraftEntries.forEach(e => {
        csv.push([e.date,e.method,e.company,e.amount,e.type,e.currentBalance,e.outstandingBalance,e.limit,e.paid].map(c => `"${String(c ?? "").replaceAll('"','""')}"`).join(","));
      });
    }
    csv.push("\n\n");
  });

  downloadCSV(csv.join("\n"), `financial_tracker_all_data_${new Date().toISOString().split("T")[0]}.csv`);
  showNotification("All data exported to CSV", "success");
}

/* =========================================================
   PDF Export (FIXED + uses latest DOM + includes Method)
========================================================= */
function exportPDF() {
  saveAll();

  if (monthsData.length === 0) {
    showNotification("No data to export", "error");
    return;
  }

  if (!window.jspdf?.jsPDF) {
    showNotification("PDF library not loaded. Check your jsPDF script links.", "error");
    return;
  }

  const doc = new window.jspdf.jsPDF({ unit: "pt", format: "a4" });

  // Title
  doc.setFontSize(18);
  doc.text("Financial Tracker Report", 40, 50);

  doc.setFontSize(10);
  doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 70);
  doc.text(`Monthly Salary: ¬£${(parseFloat(document.getElementById("salary").value || "0") || 0).toFixed(2)}`, 40, 85);

  monthsData.forEach((month, idx) => {
    if (idx > 0) doc.addPage();

    let y = 60;
    doc.setFontSize(14);
    doc.text(String(month.name || "Month"), 40, y);
    y += 18;

    const coreRows = (month.coreBills || [])
      .filter(b => b.date || b.company || (parseFloat(b.amount || 0) || 0) !== 0 || b.type || b.method)
      .map(b => [
        b.date || "",
        b.method || "",
        b.company || "",
        `¬£${(parseFloat(b.amount || 0) || 0).toFixed(2)}`,
        b.type || "",
        (b.paid === "paid") ? "‚úì" : "‚úó"
      ]);

    if (coreRows.length) {
      doc.setFontSize(11);
      doc.text("Core Bills", 40, y);
      y += 10;

      doc.autoTable({
        startY: y,
        head: [["Date","Method","Company","Amount","Type","Paid"]],
        body: coreRows,
        theme: "grid",
        margin: { left: 40, right: 40 },
        styles: { fontSize: 9 },
        headStyles: { fillColor: [37, 99, 235] }
      });

      y = doc.lastAutoTable.finalY + 18;
    }

    const debtRows = (month.overdraftEntries || [])
      .filter(e => e.date || e.company || (parseFloat(e.amount || 0) || 0) !== 0 || e.type || e.currentBalance || e.outstandingBalance || e.limit || e.method)
      .map(e => [
        e.date || "",
        e.method || "",
        e.company || "",
        `¬£${(parseFloat(e.amount || 0) || 0).toFixed(2)}`,
        e.type || "",
        e.currentBalance ? `¬£${(parseFloat(e.currentBalance || 0) || 0).toFixed(2)}` : "",
        e.outstandingBalance ? `¬£${(parseFloat(e.outstandingBalance || 0) || 0).toFixed(2)}` : "",
        e.limit ? `¬£${(parseFloat(e.limit || 0) || 0).toFixed(2)}` : "",
        (e.paid === "paid") ? "‚úì" : "‚úó"
      ]);

    if (debtRows.length) {
      doc.setFontSize(11);
      doc.text("Overdraft / BNPL / Finance Plan / Debt", 40, y);
      y += 10;

      doc.autoTable({
        startY: y,
        head: [["Date","Method","Company","Amount","Type","Current","Outstanding","Limit","Paid"]],
        body: debtRows,
        theme: "grid",
        margin: { left: 40, right: 40 },
        styles: { fontSize: 8 },
        headStyles: { fillColor: [37, 99, 235] }
      });

      y = doc.lastAutoTable.finalY + 18;
    }

    const coreTotal = (month.coreBills || []).reduce((s,b)=>s+(parseFloat(b.amount||0)||0),0);
    const debtTotal = (month.overdraftEntries || []).reduce((s,e)=>s+(parseFloat(e.amount||0)||0),0);
    const salary = (parseFloat(document.getElementById("salary").value || "0") || 0);
    const remaining = salary - coreTotal - debtTotal;

    doc.setFontSize(11);
    doc.text("Summary", 40, y);
    y += 14;
    doc.setFontSize(10);
    doc.text(`Total Core Bills: ¬£${coreTotal.toFixed(2)}`, 55, y); y += 12;
    doc.text(`Total Overdraft/Debt: ¬£${debtTotal.toFixed(2)}`, 55, y); y += 12;
    doc.text(`Remaining Salary: ¬£${remaining.toFixed(2)}`, 55, y);
  });

  doc.save(`financial_tracker_report_${new Date().toISOString().split("T")[0]}.pdf`);
  showNotification("PDF exported successfully", "success");
}

/* =========================================================
   Autosave + Keyboard
========================================================= */
setInterval(() => { try { saveAll(); } catch {} }, 30000);
window.addEventListener("beforeunload", () => { try { saveAll(); } catch {} });

document.addEventListener("keydown", (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
    e.preventDefault();
    saveAll();
    showNotification("Data saved", "success");
  }
  if (e.key === "Escape") {
    closeListManager();
    document.querySelector(".modal-overlay")?.remove();
  }
  if (e.key === "ArrowLeft") prevMonth();
  if (e.key === "ArrowRight") nextMonth();
});

/* =========================================================
   DOM Ready
========================================================= */
document.addEventListener("DOMContentLoaded", initApp);
</script>
</body>
</html>
