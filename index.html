<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Financial Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
  --bg: #f4f6f9;
  --card: #fff;
  --text: #111827;
  --line: #e5e7eb;
  --accent: #2563eb;
  --soft: #e7f0ff;
  --radius: 8px;
  --success: #059669;
  --danger: #dc2626;
  --warning: #d97706;
  --nav-height: 60px;
}
body.dark {
  --bg: #0d1117;
  --card: #161b22;
  --text: #e6edf3;
  --line: #30363d;
  --soft: #1f2937;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  line-height: 1.5;
  font-size: 14px;
  padding-bottom: var(--nav-height);
}
.page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px;
  background: var(--card);
  min-height: calc(100vh - var(--nav-height));
}
.header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--line);
  position: relative;
}
h1 { margin: 0 0 8px 0; font-weight: 600; font-size: 24px; }
.subtitle { color: var(--text); opacity: 0.7; margin: 0; font-size: 14px; }

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
  align-items: center;
}
button {
  background: var(--accent);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
button:hover { opacity: 0.9; transform: translateY(-1px); }
button:active { transform: translateY(0); }
button.secondary { background: #4b5563; }
button.danger { background: var(--danger); }
button.success { background: var(--success); }
button.warning { background: var(--warning); }

.salary-input {
  background: var(--soft);
  padding: 16px;
  border-radius: var(--radius);
  margin-bottom: 20px;
}
.salary-input label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 15px; }
.salary-input input {
  width: 100%;
  max-width: 300px;
  padding: 10px 14px;
  border-radius: var(--radius);
  border: 1px solid var(--line);
  background: var(--card);
  color: var(--text);
  font-size: 16px;
}
.salary-input input:focus { outline: 2px solid var(--accent); border-color: transparent; }

.month-section {
  background: var(--bg);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 20px;
  border: 1px solid var(--line);
  display: none;
}
.month-section.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.month-header {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--line);
}
@media (min-width: 768px) {
  .month-header { flex-direction: row; justify-content: space-between; align-items: center; }
}
.month-header h2 { margin: 0; font-weight: 600; font-size: 20px; flex: 1; }
.month-header input {
  font-size: 20px;
  font-weight: 600;
  background: transparent;
  border: none;
  color: var(--text);
  padding: 8px;
  border-radius: 4px;
  width: 100%;
  max-width: 300px;
}
.month-header input:focus { outline: 2px solid var(--accent); background: var(--card); }
.month-actions { display: flex; gap: 8px; flex-wrap: wrap; }

.table-section { margin-bottom: 24px; }
.table-section h3 {
  margin: 0 0 12px 0;
  font-weight: 500;
  font-size: 16px;
  color: var(--text);
  opacity: 0.9;
  display: flex;
  align-items: center;
  gap: 8px;
}
.table-container {
  overflow-x: auto;
  border-radius: var(--radius);
  border: 1px solid var(--line);
  margin-bottom: 12px;
  -webkit-overflow-scrolling: touch;
}
table { width: 100%; border-collapse: collapse; min-width: 800px; }
thead { background: var(--soft); }
th {
  padding: 12px 8px;
  text-align: left;
  font-weight: 500;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text);
  opacity: 0.7;
  border-bottom: 1px solid var(--line);
  white-space: nowrap;
}
td {
  padding: 12px 8px;
  border-bottom: 1px solid var(--line);
  background: var(--card);
  vertical-align: middle;
}
tbody tr:hover td { background: var(--soft); }
tbody tr:last-child td { border-bottom: none; }

input, select {
  width: 100%;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid var(--line);
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  box-sizing: border-box;
  min-height: 40px;
}
input:focus, select:focus { outline: 2px solid var(--accent); border-color: transparent; }
.radio-group { display: flex; gap: 12px; flex-wrap: wrap; }
.radio-group label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; white-space: nowrap; }
input[type="radio"] { width: auto; margin: 0; min-height: auto; }

.paid-status { min-width: 120px; }
.actions { white-space: nowrap; min-width: 60px; }
.delete-btn {
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  padding: 8px;
  border-radius: 4px;
  font-size: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
}
.delete-btn:hover { background: rgba(220, 38, 38, 0.1); }

.summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid var(--line);
}
.summary-item { background: var(--soft); padding: 16px; border-radius: var(--radius); text-align: center; }
.summary-item span { display: block; font-size: 13px; opacity: 0.7; margin-bottom: 8px; font-weight: 500; }
.summary-item b { font-size: 20px; font-weight: 600; }

.dark-toggle {
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 1000;
  background: var(--accent);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex; align-items: center; justify-content: center;
  z-index: 2000; padding: 20px;
}
.modal {
  background: var(--card);
  border-radius: var(--radius);
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.modal-header {
  padding: 20px;
  border-bottom: 1px solid var(--line);
  display: flex;
  align-items: center;
  gap: 12px;
}
.modal-header h3 { margin: 0; flex: 1; font-size: 18px; }
.modal-close {
  background: none; border: none; color: var(--text);
  cursor: pointer; padding: 8px; border-radius: 4px; font-size: 20px;
}
.modal-close:hover { background: var(--soft); }
.modal-content { padding: 20px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 20px; border-top: 1px solid var(--line); display: flex; gap: 8px; justify-content: flex-end; }

.methods-list { margin: 0; padding: 0; list-style: none; }
.method-item {
  display: flex; align-items: center; gap: 10px;
  padding: 12px; border-radius: var(--radius);
  margin-bottom: 8px; background: var(--soft);
}
.method-item input { flex: 1; margin: 0; }
.add-method-form { display: flex; gap: 10px; margin-top: 20px; }
.add-method-form input { flex: 1; margin: 0; }

@media (max-width: 768px) {
  .page { padding: 12px; }
  h1 { font-size: 22px; }
  .controls { flex-direction: column; align-items: stretch; }
  .controls button { width: 100%; justify-content: center; }
  .salary-input input { max-width: 100%; }
  .month-actions { width: 100%; }
  .month-actions button { flex: 1; min-width: 0; }
  table { font-size: 13px; }
  th, td { padding: 10px 6px; }
  .summary { grid-template-columns: 1fr; }
}

.loading {
  display: none;
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 3000;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: var(--text);
}
.loading.active { display: flex; }

.last-saved {
  font-size: 12px;
  opacity: 0.7;
  margin-left: auto;
  padding: 4px 8px;
  background: var(--soft);
  border-radius: 4px;
  display: none;
}
@media (min-width: 768px) { .last-saved { display: block; } }

.empty-state { text-align: center; padding: 40px 20px; color: var(--text); opacity: 0.6; }
.empty-state p { margin: 8px 0; }

.notification {
  position: fixed;
  bottom: calc(var(--nav-height) + 20px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--danger);
  color: white;
  padding: 12px 20px;
  border-radius: var(--radius);
  z-index: 1001;
  display: none;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.notification.show { display: flex; animation: slideUp 0.3s ease; }
@keyframes slideUp {
  from { transform: translateX(-50%) translateY(100px); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin: 20px 0;
  padding: 10px;
  border-top: 1px solid var(--line);
}
.pagination-btn {
  padding: 8px 16px;
  background: var(--soft);
  color: var(--text);
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.pagination-btn:hover:not(:disabled) { background: var(--accent); color: white; }
.pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.pagination-info { font-size: 14px; color: var(--text); opacity: 0.7; }

.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: var(--nav-height);
  background: var(--card);
  border-top: 1px solid var(--line);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 1000;
  padding: 0 10px;
}
.nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  background: none;
  border: none;
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 12px;
  opacity: 0.7;
  transition: all 0.2s;
  flex: 1;
  max-width: 100px;
}
.nav-btn:hover { opacity: 1; background: var(--soft); }
.nav-btn.active { opacity: 1; color: var(--accent); background: var(--soft); }
.nav-icon { font-size: 20px; }

.reports-page { display: none; }
.reports-page.active { display: block; }
.report-card {
  background: var(--soft);
  padding: 20px;
  border-radius: var(--radius);
  margin-bottom: 16px;
  cursor: pointer;
  transition: all 0.2s;
}
.report-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.report-card h3 { margin: 0 0 8px 0; font-size: 16px; }
.report-card p { margin: 0; opacity: 0.7; font-size: 13px; }
.help-text { font-size: 12px; opacity: 0.6; margin-top: 4px; display: block; }
.reports-modal { max-width: 800px; }
.report-section { margin-bottom: 24px; }
.report-section h4 { margin: 0 0 12px 0; font-size: 15px; color: var(--text); opacity: 0.9; }
</style>
</head>

<body>

<button class="dark-toggle" onclick="toggleDarkMode()">üåô Dark</button>

<div class="loading" id="loading">Loading your data...</div>
<div class="notification" id="notification"></div>

<!-- Home Page -->
<div id="home-page" class="page">
  <div class="header">
    <h1>Financial Tracker</h1>
    <p class="subtitle">Core Bills ‚Ä¢ Overdraft Tracking ‚Ä¢ BNPL ‚Ä¢ Finance Plans ‚Ä¢ Debt</p>
  </div>

  <div class="salary-input">
    <label for="salary">Monthly Salary (¬£)</label>
    <input id="salary" type="number" value="0" min="0" step="0.01" oninput="saveAll()" placeholder="Enter your monthly salary">
  </div>

  <div class="controls">
    <button onclick="addMonth()">üìÖ Add Month</button>
    <button class="success" onclick="exportPDF()">üìÑ Export PDF</button>
    <button class="secondary" onclick="exportAllCSV()">üìä Export All CSV</button>
    <button class="secondary" onclick="showBackupManager()">üíæ Backup</button>
    <div class="last-saved" id="last-saved">Ready</div>
  </div>

  <div id="months-container">
    <div class="empty-state" id="empty-state">
      <h3>No months added yet</h3>
      <p>Click "Add Month" to start tracking your finances</p>
    </div>
  </div>

  <div class="pagination" id="pagination" style="display: none;">
    <button class="pagination-btn" onclick="prevMonth()" id="prev-btn">‚Üê Previous</button>
    <div class="pagination-info" id="page-info">Month 1 of 1</div>
    <button class="pagination-btn" onclick="nextMonth()" id="next-btn">Next ‚Üí</button>
  </div>
</div>

<!-- Reports Page -->
<div id="reports-page" class="page reports-page">
  <div class="header">
    <h1>Reports & Analytics</h1>
    <p class="subtitle">View insights and trends from your financial data</p>
  </div>

  <div class="report-card" onclick="showMonthlySummaryReport()">
    <h3>üìä Monthly Summary</h3>
    <p>Overview of all months with totals and comparisons</p>
  </div>

  <div class="report-card" onclick="showCategoryBreakdown()">
    <h3>üìà Category Breakdown</h3>
    <p>Analysis of spending by payment type and category</p>
  </div>

  <div class="report-card" onclick="showPaymentMethodAnalysis()">
    <h3>üí≥ Payment Method Analysis</h3>
    <p>See which payment methods you use most frequently</p>
  </div>

  <div class="report-card" onclick="showDebtOverview()">
    <h3>üìâ Debt & Overdraft Overview</h3>
    <p>Track your debt, overdraft, and finance plan balances</p>
  </div>

  <div class="report-card" onclick="showYearlyTrends()">
    <h3>üìÖ Yearly Trends</h3>
    <p>View your financial patterns over time</p>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <button class="nav-btn active" id="nav-home" onclick="showPage('home')">
    <span class="nav-icon">üè†</span>
    <span>Home</span>
  </button>
  <button class="nav-btn" id="nav-reports" onclick="showPage('reports')">
    <span class="nav-icon">üìä</span>
    <span>Reports</span>
  </button>
</div>

<script>
/* =========================
   FIXES INCLUDED
   1) PDF export hardened (safe number parsing, no NaN)
   2) Backup/restore includes ALL dropdown lists + dark mode
   3) ALL dropdowns are user-extensible via one manager modal:
      - Payment Methods
      - Core Bill Types
      - Debt/Overdraft Types
   4) Radio bug fixed: each row has unique group name (no cross-row interference)
   ========================= */

// jsPDF UMD binding
window.jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;

// Global variables
let currentMonthIndex = 0;
let monthsData = [];

// Dropdown lists (all user-extensible)
const LIST_KEYS = {
  methods: 'fin_tracker_methods',
  coreTypes: 'fin_tracker_core_types',
  debtTypes: 'fin_tracker_debt_types'
};

const DEFAULT_LISTS = {
  [LIST_KEYS.methods]: [
    "Cash", "Debit Card", "Credit Card", "Bank Transfer", "Direct Debit",
    "Standing Order", "PayPal", "Apple Pay", "Google Pay", "Other"
  ],
  [LIST_KEYS.coreTypes]: [
    "Utility", "Rent/Mortgage", "Insurance", "Subscription", "Loan", "Other"
  ],
  [LIST_KEYS.debtTypes]: [
    "Overdraft", "BNPL", "Finance Plan", "Debt"
  ]
};

// Runtime lists
window.lists = {
  [LIST_KEYS.methods]: [],
  [LIST_KEYS.coreTypes]: [],
  [LIST_KEYS.debtTypes]: []
};

// Generic list manager modal
let listManagerModal = null;
let listManagerKey = null;

// Utility: safe number parsing
function n(v) {
  const x = parseFloat(v);
  return Number.isFinite(x) ? x : 0;
}

// Utility: unique row id
function uid(prefix = 'r') {
  return `${prefix}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
}

// Initialize app
function initApp() {
  showLoading(true);

  try {
    // Restore dark mode
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
      document.querySelector('.dark-toggle').textContent = '‚òÄÔ∏è Light';
    }

    // Restore lists
    for (const key of Object.values(LIST_KEYS)) {
      const saved = localStorage.getItem(key);
      if (saved) {
        try {
          const arr = JSON.parse(saved);
          window.lists[key] = Array.isArray(arr) && arr.length ? arr : DEFAULT_LISTS[key].slice();
        } catch {
          window.lists[key] = DEFAULT_LISTS[key].slice();
        }
      } else {
        window.lists[key] = DEFAULT_LISTS[key].slice();
      }
    }

    // Restore app data
    const savedData = localStorage.getItem('fin_tracker_data');
    if (savedData) {
      try {
        const data = JSON.parse(savedData);

        if (data.salary !== undefined) {
          document.getElementById('salary').value = data.salary;
        }

        if (data.months && data.months.length > 0) {
          monthsData = data.months;
          currentMonthIndex = Math.min(currentMonthIndex, monthsData.length - 1);
          renderCurrentMonth();
          document.getElementById('empty-state').style.display = 'none';
          document.getElementById('pagination').style.display = 'flex';
        } else {
          // show empty state
          document.getElementById('empty-state').style.display = 'block';
        }

      } catch (e) {
        console.error('Error parsing saved data:', e);
        showNotification('Error loading saved data. Starting fresh.', 'error');
        monthsData = [];
        saveLists();
      }
    } else {
      // no saved data
      document.getElementById('empty-state').style.display = 'block';
    }

    updateLastSaved('Data loaded');
  } catch (error) {
    console.error('Error initializing app:', error);
    showNotification('Error loading app. Please refresh.', 'error');
  } finally {
    setTimeout(() => showLoading(false), 300);
  }
}

// Notifications
function showNotification(message, type = 'info') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = 'notification show';

  if (type === 'error') notification.style.background = 'var(--danger)';
  else if (type === 'success') notification.style.background = 'var(--success)';
  else notification.style.background = 'var(--accent)';

  setTimeout(() => { notification.className = 'notification'; }, 3000);
}

// Loading indicator
function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

// Save lists
function saveLists() {
  for (const key of Object.values(LIST_KEYS)) {
    localStorage.setItem(key, JSON.stringify(window.lists[key]));
  }
}

// Save all app data
function saveAll() {
  try {
    const salary = document.getElementById('salary').value;

    // Update current month data
    if (monthsData[currentMonthIndex]) {
      const monthEl = document.querySelector('.month-section.active');
      if (monthEl) {
        monthsData[currentMonthIndex] = readMonthFromDOM(monthEl);
      }
    }

    const dataToSave = {
      salary: salary,
      months: monthsData,
      lastSaved: new Date().toISOString()
    };

    localStorage.setItem('fin_tracker_data', JSON.stringify(dataToSave));

    updateAll();
    updateLastSaved();
  } catch (error) {
    console.error('Error saving data:', error);
    showNotification('Error saving data', 'error');
  }
}

// Read month DOM -> object (radio FIXED)
function readMonthFromDOM(monthEl) {
  const monthData = {
    id: monthEl.id,
    name: monthEl.querySelector('.month-name')?.value || 'New Month',
    coreBills: [],
    overdraftEntries: []
  };

  monthEl.querySelectorAll('#core-bills-table tbody tr').forEach(row => {
    monthData.coreBills.push({
      date: row.querySelector('.date-input')?.value || '',
      method: row.querySelector('.payment-method')?.value || '',
      company: row.querySelector('.company-input')?.value || '',
      amount: row.querySelector('.amount-input')?.value || '0',
      type: row.querySelector('.type-select')?.value || '',
      paid: row.querySelector('input[type="radio"][data-field="paid"]:checked')?.value || 'not-paid'
    });
  });

  monthEl.querySelectorAll('#overdraft-table tbody tr').forEach(row => {
    monthData.overdraftEntries.push({
      date: row.querySelector('.date-input')?.value || '',
      method: row.querySelector('.payment-method')?.value || '',
      company: row.querySelector('.company-input')?.value || '',
      amount: row.querySelector('.amount-input')?.value || '0',
      type: row.querySelector('.type-select')?.value || '',
      currentBalance: row.querySelector('.current-balance')?.value || '',
      outstandingBalance: row.querySelector('.outstanding-balance')?.value || '',
      limit: row.querySelector('.limit-input')?.value || '',
      paid: row.querySelector('input[type="radio"][data-field="paid"]:checked')?.value || 'not-paid'
    });
  });

  return monthData;
}

// Last saved indicator
function updateLastSaved(message) {
  const el = document.getElementById('last-saved');
  if (message) el.textContent = message;
  else {
    const now = new Date();
    el.textContent = `Saved: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
  }
}

/* =========================
   GENERIC DROPDOWN MANAGER
   ========================= */
function showListManager(key, title) {
  listManagerKey = key;

  if (listManagerModal) listManagerModal.remove();

  const items = window.lists[key] || [];

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="closeListManager()">‚Üê</button>
        <h3>${title}</h3>
        <button class="modal-close" onclick="closeListManager()">√ó</button>
      </div>
      <div class="modal-content">
        <p style="margin-top: 0; opacity: 0.7; font-size: 14px;">Add, edit, or remove options</p>

        <div id="list-items-container">
          ${items.map((val, idx) => `
            <div class="method-item" data-index="${idx}">
              <input type="text" value="${escapeHtml(val)}"
                oninput="updateListItem(${idx}, this.value)"
                placeholder="Option">
              <button class="delete-btn" onclick="removeListItem(${idx})" style="font-size: 14px;">Remove</button>
            </div>
          `).join('')}
        </div>

        <div class="add-method-form">
          <input type="text" id="new-list-item" placeholder="New option" onkeypress="if(event.key==='Enter') addListItem()">
          <button class="success" onclick="addListItem()">Add</button>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeListManager()">Close</button>
        <button class="success" onclick="saveListAndClose()">Save & Close</button>
      </div>
    </div>
  `;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = modalHTML;
  overlay.onclick = (e) => { if (e.target === overlay) closeListManager(); };

  document.body.appendChild(overlay);
  listManagerModal = overlay;

  setTimeout(() => document.getElementById('new-list-item')?.focus(), 100);
}

function closeListManager() {
  if (listManagerModal) {
    listManagerModal.remove();
    listManagerModal = null;
    listManagerKey = null;
  }
}

function saveListAndClose() {
  // Clean + de-dupe + ensure at least 1 item
  const key = listManagerKey;
  let arr = (window.lists[key] || []).map(s => (s || '').trim()).filter(Boolean);
  arr = Array.from(new Set(arr));

  if (arr.length === 0) {
    showNotification('You must keep at least one option.', 'error');
    return;
  }

  window.lists[key] = arr;
  saveLists();

  // Re-render dropdowns on page
  renderAllDropdowns();

  closeListManager();
  saveAll();
  showNotification('Options saved', 'success');
}

function updateListItem(index, value) {
  if (!listManagerKey) return;
  window.lists[listManagerKey][index] = value;
}

function removeListItem(index) {
  if (!listManagerKey) return;
  if (window.lists[listManagerKey].length <= 1) {
    showNotification('You must keep at least one option.', 'error');
    return;
  }
  window.lists[listManagerKey].splice(index, 1);

  // Repaint modal list
  const container = document.getElementById('list-items-container');
  if (!container) return;
  container.innerHTML = window.lists[listManagerKey].map((val, idx) => `
    <div class="method-item" data-index="${idx}">
      <input type="text" value="${escapeHtml(val)}"
        oninput="updateListItem(${idx}, this.value)"
        placeholder="Option">
      <button class="delete-btn" onclick="removeListItem(${idx})" style="font-size: 14px;">Remove</button>
    </div>
  `).join('');
}

function addListItem() {
  if (!listManagerKey) return;
  const input = document.getElementById('new-list-item');
  const value = (input.value || '').trim();
  if (!value) return;

  const existing = (window.lists[listManagerKey] || []).map(v => (v || '').trim().toLowerCase());
  if (existing.includes(value.toLowerCase())) {
    showNotification('That option already exists.', 'error');
    return;
  }

  window.lists[listManagerKey].push(value);

  const container = document.getElementById('list-items-container');
  if (container) {
    const idx = window.lists[listManagerKey].length - 1;
    container.innerHTML += `
      <div class="method-item" data-index="${idx}">
        <input type="text" value="${escapeHtml(value)}"
          oninput="updateListItem(${idx}, this.value)"
          placeholder="Option">
        <button class="delete-btn" onclick="removeListItem(${idx})" style="font-size: 14px;">Remove</button>
      </div>
    `;
  }

  input.value = '';
  input.focus();
}

function escapeHtml(str) {
  return String(str ?? '').replace(/[&<>"']/g, (m) => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

// Dropdown builders
function getSelectHTML(key, current = '', cssClass = '', manageLabel = '‚öô Manage...') {
  const options = window.lists[key] || [];
  return `
    <select class="${cssClass}" data-list-key="${key}" onchange="handleSelectChange(this)">
      <option value=""></option>
      ${options.map(o => `<option value="${escapeHtml(o)}" ${o === current ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('')}
      <option value="__manage">${manageLabel}</option>
    </select>
  `;
}

function handleSelectChange(select) {
  if (select.value === '__manage') {
    const key = select.getAttribute('data-list-key');
    select.value = '';
    if (key === LIST_KEYS.methods) showListManager(LIST_KEYS.methods, 'Manage Payment Methods');
    else if (key === LIST_KEYS.coreTypes) showListManager(LIST_KEYS.coreTypes, 'Manage Core Bill Types');
    else if (key === LIST_KEYS.debtTypes) showListManager(LIST_KEYS.debtTypes, 'Manage Debt/Overdraft Types');
    return;
  }
  saveAll();
}

function renderAllDropdowns() {
  // Rebuild all selects that are tied to lists, preserving current value
  document.querySelectorAll('select[data-list-key]').forEach(sel => {
    const key = sel.getAttribute('data-list-key');
    const current = sel.value;
    const cls = sel.className;
    const manageLabel = (key === LIST_KEYS.methods) ? '‚öô Manage Methods...' : '‚öô Manage Options...';
    sel.outerHTML = getSelectHTML(key, current, cls, manageLabel);
  });
}

/* =========================
   ROW TEMPLATES (RADIO FIX)
   ========================= */
function getCoreBillsRow(data = {}) {
  const group = uid('paid-core');
  return `
    <tr>
      <td><input type="date" class="date-input" value="${escapeHtml(data.date || '')}" oninput="saveAll()"></td>
      <td>${getSelectHTML(LIST_KEYS.methods, data.method || '', 'payment-method', '‚öô Manage Methods...')}</td>
      <td><input type="text" class="company-input" value="${escapeHtml(data.company || '')}" placeholder="Company" oninput="saveAll()"></td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.amount ?? '0')}" class="amount-input" oninput="saveAll()"></td>
      <td>
        ${getSelectHTML(LIST_KEYS.coreTypes, data.type || '', 'type-select', '‚öô Manage Options...')}
      </td>
      <td class="paid-status">
        <div class="radio-group">
          <label><input type="radio" data-field="paid" name="${group}" value="paid" ${data.paid === 'paid' ? 'checked' : ''} onchange="saveAll()"> Paid</label>
          <label><input type="radio" data-field="paid" name="${group}" value="not-paid" ${data.paid !== 'paid' ? 'checked' : ''} onchange="saveAll()"> Not Paid</label>
        </div>
      </td>
      <td class="actions">
        <button class="delete-btn" onclick="deleteRow(this)" title="Delete row">‚úï</button>
      </td>
    </tr>
  `;
}

function getOverdraftRow(data = {}) {
  const group = uid('paid-debt');
  return `
    <tr>
      <td><input type="date" class="date-input" value="${escapeHtml(data.date || '')}" oninput="saveAll()"></td>
      <td>${getSelectHTML(LIST_KEYS.methods, data.method || '', 'payment-method', '‚öô Manage Methods...')}</td>
      <td><input type="text" class="company-input" value="${escapeHtml(data.company || '')}" placeholder="Bank/Company" oninput="saveAll()"></td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.amount ?? '0')}" class="amount-input" oninput="saveAll()"></td>
      <td>
        ${getSelectHTML(LIST_KEYS.debtTypes, data.type || '', 'type-select', '‚öô Manage Options...')}
      </td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.currentBalance || '')}" class="current-balance" placeholder="Current Balance" oninput="saveAll()"></td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.outstandingBalance || '')}" class="outstanding-balance" placeholder="Outstanding Balance" oninput="saveAll()"></td>
      <td><input type="number" step="0.01" value="${escapeHtml(data.limit || '')}" class="limit-input" placeholder="Limit" oninput="saveAll()"></td>
      <td class="paid-status">
        <div class="radio-group">
          <label><input type="radio" data-field="paid" name="${group}" value="paid" ${data.paid === 'paid' ? 'checked' : ''} onchange="saveAll()"> Paid</label>
          <label><input type="radio" data-field="paid" name="${group}" value="not-paid" ${data.paid !== 'paid' ? 'checked' : ''} onchange="saveAll()"> Not Paid</label>
        </div>
      </td>
      <td class="actions">
        <button class="delete-btn" onclick="deleteRow(this)" title="Delete row">‚úï</button>
      </td>
    </tr>
  `;
}

/* =========================
   MONTH RENDERING + PAGING
   ========================= */
function renderCurrentMonth() {
  const container = document.getElementById('months-container');

  if (monthsData.length === 0) {
    container.innerHTML = `
      <div class="empty-state" id="empty-state">
        <h3>No months added yet</h3>
        <p>Click "Add Month" to start tracking your finances</p>
      </div>`;
    document.getElementById('pagination').style.display = 'none';
    return;
  }

  document.getElementById('empty-state')?.style && (document.getElementById('empty-state').style.display = 'none');
  document.getElementById('pagination').style.display = 'flex';

  container.innerHTML = '';

  const monthData = monthsData[currentMonthIndex];
  const monthEl = createMonthElement(monthData);
  monthEl.classList.add('active');
  container.appendChild(monthEl);

  updateAll();
  updatePagination();
}

function createMonthElement(monthData) {
  const div = document.createElement('div');
  div.className = 'month-section';
  div.id = monthData.id || ('month-' + Date.now());

  const coreRows = (monthData.coreBills && monthData.coreBills.length)
    ? monthData.coreBills.map(b => getCoreBillsRow(b)).join('')
    : getCoreBillsRow();

  const debtRows = (monthData.overdraftEntries && monthData.overdraftEntries.length)
    ? monthData.overdraftEntries.map(e => getOverdraftRow(e)).join('')
    : getOverdraftRow();

  div.innerHTML = `
    <div class="month-header">
      <input type="text" class="month-name" value="${escapeHtml(monthData.name || 'New Month')}" oninput="saveAll()">
      <div class="month-actions">
        <button class="warning" onclick="clearMonth(${currentMonthIndex})">üóëÔ∏è Clear</button>
        <button class="secondary" onclick="exportMonthCSV(${currentMonthIndex})">üìä CSV</button>
        <button class="danger" onclick="deleteMonth(${currentMonthIndex})">üóëÔ∏è Delete</button>
      </div>
    </div>

    <div class="table-section">
      <h3>üìã Core Bills</h3>
      <div class="table-container">
        <table id="core-bills-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Payment Method</th>
              <th>Company</th>
              <th>Amount (¬£)</th>
              <th>Payment Type</th>
              <th>Paid Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${coreRows}</tbody>
        </table>
      </div>
      <button class="secondary" onclick="addCoreBillsRow(this)" style="margin-top: 8px;">+ Add Bill</button>
      <div style="margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="secondary" onclick="showListManager('${LIST_KEYS.methods}', 'Manage Payment Methods')">‚öô Manage Payment Methods</button>
        <button class="secondary" onclick="showListManager('${LIST_KEYS.coreTypes}', 'Manage Core Bill Types')">‚öô Manage Core Bill Types</button>
      </div>
    </div>

    <div class="table-section">
      <h3>üí≥ Overdraft Tracking, BNPL, Finance Plan, Debt Tracking</h3>
      <div class="table-container">
        <table id="overdraft-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Payment Method</th>
              <th>Bank/Company</th>
              <th>Amount (¬£)</th>
              <th>Payment Type</th>
              <th>Current Balance</th>
              <th>Outstanding Balance</th>
              <th>Limit</th>
              <th>Paid Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${debtRows}</tbody>
        </table>
      </div>
      <button class="secondary" onclick="addOverdraftRow(this)" style="margin-top: 8px;">+ Add Entry</button>
      <span class="help-text">For Overdraft: Current Balance = current amount, Outstanding = remaining, Limit = max allowed</span>
      <div style="margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="secondary" onclick="showListManager('${LIST_KEYS.debtTypes}', 'Manage Debt/Overdraft Types')">‚öô Manage Debt/Overdraft Types</button>
      </div>
    </div>

    <div class="summary">
      <div class="summary-item">
        <span>Total Core Bills</span>
        <b class="core-total">¬£0.00</b>
      </div>
      <div class="summary-item">
        <span>Total Overdraft/Debt</span>
        <b class="overdraft-total">¬£0.00</b>
      </div>
      <div class="summary-item">
        <span>Remaining Salary</span>
        <b class="remaining-salary">¬£0.00</b>
      </div>
    </div>
  `;

  return div;
}

// Pagination
function updatePagination() {
  const pageInfo = document.getElementById('page-info');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');

  pageInfo.textContent = `Month ${currentMonthIndex + 1} of ${monthsData.length}`;
  prevBtn.disabled = currentMonthIndex === 0;
  nextBtn.disabled = currentMonthIndex === monthsData.length - 1;
}

function prevMonth() {
  if (currentMonthIndex > 0) {
    saveCurrentMonthData();
    currentMonthIndex--;
    renderCurrentMonth();
  }
}

function nextMonth() {
  if (currentMonthIndex < monthsData.length - 1) {
    saveCurrentMonthData();
    currentMonthIndex++;
    renderCurrentMonth();
  }
}

function saveCurrentMonthData() {
  const monthEl = document.querySelector('.month-section.active');
  if (monthEl && monthsData[currentMonthIndex]) {
    monthsData[currentMonthIndex] = readMonthFromDOM(monthEl);
  }
}

// Row operations
function addCoreBillsRow(button) {
  const tbody = button.previousElementSibling.querySelector('tbody');
  tbody.insertAdjacentHTML('beforeend', getCoreBillsRow());
  saveAll();
}

function addOverdraftRow(button) {
  const tbody = button.previousElementSibling.querySelector('tbody');
  tbody.insertAdjacentHTML('beforeend', getOverdraftRow());
  saveAll();
}

function deleteRow(button) {
  const row = button.closest('tr');
  if (row.parentElement.children.length > 1) {
    row.remove();
    saveAll();
  } else {
    showNotification('Cannot delete the last row. Clear the month instead.', 'error');
  }
}

// Month operations
function addMonth() {
  saveCurrentMonthData();

  const monthId = 'month-' + Date.now();
  const monthName = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

  const newMonth = { id: monthId, name: monthName, coreBills: [], overdraftEntries: [] };
  monthsData.push(newMonth);
  currentMonthIndex = monthsData.length - 1;

  renderCurrentMonth();
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('pagination').style.display = 'flex';

  saveAll();
  showNotification('Month added successfully', 'success');
}

function clearMonth(index) {
  if (confirm('Clear all data in this month? This cannot be undone.')) {
    if (monthsData[index]) {
      monthsData[index].coreBills = [];
      monthsData[index].overdraftEntries = [];
      renderCurrentMonth();
      saveAll();
      showNotification('Month cleared', 'success');
    }
  }
}

function deleteMonth(index) {
  if (confirm('Delete this entire month? This cannot be undone.')) {
    monthsData.splice(index, 1);

    if (currentMonthIndex >= monthsData.length) {
      currentMonthIndex = Math.max(0, monthsData.length - 1);
    }

    if (monthsData.length === 0) {
      document.getElementById('pagination').style.display = 'none';
      document.getElementById('months-container').innerHTML = `
        <div class="empty-state" id="empty-state">
          <h3>No months added yet</h3>
          <p>Click "Add Month" to start tracking your finances</p>
        </div>`;
    } else {
      renderCurrentMonth();
    }

    saveAll();
    showNotification('Month deleted', 'success');
  }
}

// Calculations
function calculateMonthTotals(month) {
  let coreTotal = 0;
  let overdraftTotal = 0;

  month.querySelectorAll('#core-bills-table tbody tr').forEach(row => {
    coreTotal += n(row.querySelector('.amount-input')?.value);
  });

  month.querySelectorAll('#overdraft-table tbody tr').forEach(row => {
    overdraftTotal += n(row.querySelector('.amount-input')?.value);
  });

  const salary = n(document.getElementById('salary').value);
  const remaining = salary - coreTotal - overdraftTotal;

  month.querySelector('.core-total').textContent = '¬£' + coreTotal.toFixed(2);
  month.querySelector('.overdraft-total').textContent = '¬£' + overdraftTotal.toFixed(2);
  month.querySelector('.remaining-salary').textContent = '¬£' + remaining.toFixed(2);
}

function updateAll() {
  const monthEl = document.querySelector('.month-section.active');
  if (monthEl) calculateMonthTotals(monthEl);
}

/* =========================
   PAGE NAVIGATION
   ========================= */
function showPage(page) {
  const homeBtn = document.getElementById('nav-home');
  const reportsBtn = document.getElementById('nav-reports');
  const homePage = document.getElementById('home-page');
  const reportsPage = document.getElementById('reports-page');

  if (page === 'home') {
    homeBtn.classList.add('active');
    reportsBtn.classList.remove('active');
    homePage.style.display = 'block';
    reportsPage.classList.remove('active');
  } else if (page === 'reports') {
    homeBtn.classList.remove('active');
    reportsBtn.classList.add('active');
    homePage.style.display = 'none';
    reportsPage.classList.add('active');
  }
}

/* =========================
   REPORTS (unchanged logic)
   ========================= */
function showMonthlySummaryReport() {
  if (monthsData.length === 0) {
    showNotification('No data available for reports', 'error');
    return;
  }

  const modalHTML = `
    <div class="modal reports-modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üìä Monthly Summary Report</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        ${generateMonthlySummaryHTML()}
      </div>
      <div class="modal-footer">
        <button class="success" onclick="exportPDF()">Export PDF</button>
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function generateMonthlySummaryHTML() {
  let html = '';
  const salary = n(document.getElementById('salary').value);

  monthsData.forEach((month) => {
    let coreTotal = 0;
    let overdraftTotal = 0;

    (month.coreBills || []).forEach(bill => coreTotal += n(bill.amount));
    (month.overdraftEntries || []).forEach(entry => overdraftTotal += n(entry.amount));

    const remaining = salary - coreTotal - overdraftTotal;

    html += `
      <div class="report-section">
        <h4>${escapeHtml(month.name)}</h4>
        <div class="summary" style="margin: 0;">
          <div class="summary-item">
            <span>Core Bills</span>
            <b>¬£${coreTotal.toFixed(2)}</b>
          </div>
          <div class="summary-item">
            <span>Overdraft/Debt</span>
            <b>¬£${overdraftTotal.toFixed(2)}</b>
          </div>
          <div class="summary-item">
            <span>Remaining</span>
            <b style="color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'}">
              ¬£${remaining.toFixed(2)}
            </b>
          </div>
        </div>
      </div>
    `;
  });

  return html;
}

function showCategoryBreakdown() {
  if (monthsData.length === 0) {
    showNotification('No data available for reports', 'error');
    return;
  }

  const categories = {};
  monthsData.forEach(month => {
    (month.coreBills || []).forEach(bill => {
      const type = bill.type || 'Uncategorized';
      const amount = n(bill.amount);
      categories[type] = (categories[type] || 0) + amount;
    });
  });

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üìà Category Breakdown</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        ${Object.entries(categories).map(([category, total]) => `
          <div style="margin-bottom: 10px; padding: 10px; background: var(--soft); border-radius: var(--radius);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>${escapeHtml(category)}</span>
              <b>¬£${total.toFixed(2)}</b>
            </div>
          </div>
        `).join('')}
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function showPaymentMethodAnalysis() {
  if (monthsData.length === 0) {
    showNotification('No data available for reports', 'error');
    return;
  }

  const methods = {};
  monthsData.forEach(month => {
    (month.coreBills || []).forEach(bill => {
      const method = bill.method || 'Not specified';
      methods[method] = (methods[method] || 0) + n(bill.amount);
    });
    (month.overdraftEntries || []).forEach(entry => {
      const method = entry.method || 'Not specified';
      methods[method] = (methods[method] || 0) + n(entry.amount);
    });
  });

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üí≥ Payment Method Analysis</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        ${Object.entries(methods)
          .sort((a, b) => b[1] - a[1])
          .map(([method, total]) => `
            <div style="margin-bottom: 10px; padding: 10px; background: var(--soft); border-radius: var(--radius);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${escapeHtml(method)}</span>
                <b>¬£${total.toFixed(2)}</b>
              </div>
            </div>
          `).join('')}
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function showDebtOverview() {
  if (monthsData.length === 0) {
    showNotification('No data available for reports', 'error');
    return;
  }

  let totalDebt = 0, totalOverdraft = 0, totalBNPL = 0, totalFinance = 0;

  monthsData.forEach(month => {
    (month.overdraftEntries || []).forEach(entry => {
      const amount = n(entry.amount);
      switch (entry.type) {
        case 'Overdraft': totalOverdraft += amount; break;
        case 'BNPL': totalBNPL += amount; break;
        case 'Finance Plan': totalFinance += amount; break;
        case 'Debt': totalDebt += amount; break;
      }
    });
  });

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üìâ Debt & Overdraft Overview</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        <div style="margin-bottom: 15px; padding: 15px; background: var(--soft); border-radius: var(--radius);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span>Total Debt</span>
            <b style="color: var(--danger)">¬£${totalDebt.toFixed(2)}</b>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span>Total Overdraft</span>
            <b style="color: var(--warning)">¬£${totalOverdraft.toFixed(2)}</b>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span>Total BNPL</span>
            <b style="color: var(--warning)">¬£${totalBNPL.toFixed(2)}</b>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>Total Finance Plans</span>
            <b style="color: var(--warning)">¬£${totalFinance.toFixed(2)}</b>
          </div>
        </div>
        <div class="help-text" style="text-align: center;">
          Total Outstanding: ¬£${(totalDebt + totalOverdraft + totalBNPL + totalFinance).toFixed(2)}
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function showYearlyTrends() {
  if (monthsData.length === 0) {
    showNotification('No data available for reports', 'error');
    return;
  }

  const years = {};
  monthsData.forEach(month => {
    const yearMatch = (month.name || '').match(/\d{4}/);
    if (!yearMatch) return;
    const year = yearMatch[0];
    if (!years[year]) years[year] = { core: 0, debt: 0, count: 0 };

    let coreTotal = 0, debtTotal = 0;
    (month.coreBills || []).forEach(b => coreTotal += n(b.amount));
    (month.overdraftEntries || []).forEach(e => debtTotal += n(e.amount));

    years[year].core += coreTotal;
    years[year].debt += debtTotal;
    years[year].count++;
  });

  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>üìÖ Yearly Trends</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        ${Object.entries(years).map(([year, data]) => `
          <div style="margin-bottom: 15px; padding: 15px; background: var(--soft); border-radius: var(--radius);">
            <h4 style="margin: 0 0 10px 0;">${escapeHtml(year)} (${data.count} months)</h4>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span>Average Core Bills:</span>
              <b>¬£${(data.core / data.count).toFixed(2)}/month</b>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>Average Debt/Overdraft:</span>
              <b>¬£${(data.debt / data.count).toFixed(2)}/month</b>
            </div>
          </div>
        `).join('')}
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

/* =========================
   DARK MODE
   ========================= */
function toggleDarkMode() {
  document.body.classList.toggle('dark');
  const button = document.querySelector('.dark-toggle');
  button.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è Light' : 'üåô Dark';
  localStorage.setItem('darkMode', document.body.classList.contains('dark'));
}

/* =========================
   BACKUP / RESTORE (FIXED)
   - includes salary, months, ALL lists, dark mode
   - validates structure
   ========================= */
function showBackupManager() {
  const modalHTML = `
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚Üê</button>
        <h3>Backup & Restore</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-content">
        <p style="margin-top: 0; opacity: 0.7; font-size: 14px;">Backup your data or restore from a backup file</p>

        <div style="margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0;">Backup Data</h4>
          <p style="margin: 0 0 10px 0; opacity: 0.7; font-size: 13px;">Download a backup of all your financial data</p>
          <button class="success" onclick="downloadBackup()" style="width: 100%;">üì• Download Backup</button>
        </div>

        <div>
          <h4 style="margin: 0 0 10px 0;">Restore Data</h4>
          <p style="margin: 0 0 10px 0; opacity: 0.7; font-size: 13px;">Upload a backup file to restore your data</p>
          <input type="file" id="restore-file" accept=".json" style="margin-bottom: 10px; padding: 8px;">
          <button class="secondary" onclick="restoreBackup()" style="width: 100%;">üì§ Restore from Backup</button>
          <p style="margin: 10px 0 0 0; font-size: 12px; opacity: 0.6; color: var(--danger);">Warning: This will replace all current data!</p>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
}

function downloadBackup() {
  // ensure latest month DOM is saved
  saveAll();

  const backup = {
    version: 2,
    exported: new Date().toISOString(),
    salary: document.getElementById('salary').value || '0',
    months: monthsData,
    lists: {
      methods: window.lists[LIST_KEYS.methods],
      coreTypes: window.lists[LIST_KEYS.coreTypes],
      debtTypes: window.lists[LIST_KEYS.debtTypes]
    },
    darkMode: document.body.classList.contains('dark')
  };

  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `financial-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showNotification('Backup downloaded successfully', 'success');
  document.querySelector('.modal-overlay')?.remove();
}

function restoreBackup() {
  const fileInput = document.getElementById('restore-file');
  const file = fileInput.files[0];

  if (!file) {
    showNotification('Please select a backup file', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);

      // Basic validation
      if (!backup || !Array.isArray(backup.months)) {
        throw new Error('Invalid backup: missing months array');
      }

      if (!confirm('Restore backup? This will replace all current data.')) return;

      // Restore salary
      document.getElementById('salary').value = backup.salary ?? '0';

      // Restore lists (new + backwards compatible)
      if (backup.lists) {
        if (Array.isArray(backup.lists.methods) && backup.lists.methods.length) window.lists[LIST_KEYS.methods] = backup.lists.methods;
        if (Array.isArray(backup.lists.coreTypes) && backup.lists.coreTypes.length) window.lists[LIST_KEYS.coreTypes] = backup.lists.coreTypes;
        if (Array.isArray(backup.lists.debtTypes) && backup.lists.debtTypes.length) window.lists[LIST_KEYS.debtTypes] = backup.lists.debtTypes;
      } else if (Array.isArray(backup.paymentMethods) && backup.paymentMethods.length) {
        // old backups
        window.lists[LIST_KEYS.methods] = backup.paymentMethods;
      }

      saveLists();

      // Restore months
      monthsData = backup.months.map(m => ({
        id: m.id || ('month-' + Date.now()),
        name: m.name || 'New Month',
        coreBills: Array.isArray(m.coreBills) ? m.coreBills : [],
        overdraftEntries: Array.isArray(m.overdraftEntries) ? m.overdraftEntries : []
      }));
      currentMonthIndex = 0;

      // Restore dark mode
      const wantDark = !!backup.darkMode;
      document.body.classList.toggle('dark', wantDark);
      document.querySelector('.dark-toggle').textContent = wantDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
      localStorage.setItem('darkMode', String(wantDark));

      renderCurrentMonth();
      saveAll();

      showNotification('Backup restored successfully', 'success');
      document.querySelector('.modal-overlay')?.remove();
    } catch (error) {
      console.error('Error restoring backup:', error);
      showNotification('Error restoring backup. Invalid file format.', 'error');
    }
  };
  reader.readAsText(file);
}

/* =========================
   CSV EXPORT (unchanged)
   ========================= */
function exportMonthCSV(index) {
  const month = monthsData[index];
  if (!month) return;

  let csv = [];

  csv.push('Core Bills');
  csv.push('Date,Payment Method,Company,Amount,Payment Type,Paid Status');
  (month.coreBills || []).forEach(bill => {
    csv.push([
      bill.date, bill.method, bill.company, bill.amount, bill.type, bill.paid
    ].map(c => `"${String(c ?? '').replace(/"/g,'""')}"`).join(','));
  });

  csv.push('', '');

  csv.push('Overdraft, BNPL, Finance Plan, Debt Tracking');
  csv.push('Date,Payment Method,Bank/Company,Amount,Payment Type,Current Balance,Outstanding Balance,Limit,Paid Status');
  (month.overdraftEntries || []).forEach(entry => {
    csv.push([
      entry.date, entry.method, entry.company, entry.amount, entry.type,
      entry.currentBalance, entry.outstandingBalance, entry.limit, entry.paid
    ].map(c => `"${String(c ?? '').replace(/"/g,'""')}"`).join(','));
  });

  downloadCSV(csv.join('\n'), `${(month.name || 'Month').replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
  showNotification('CSV exported successfully', 'success');
}

function exportAllCSV() {
  if (monthsData.length === 0) {
    showNotification('No data to export', 'error');
    return;
  }

  let csv = ['Financial Tracker - All Data'];
  csv.push(`Generated: ${new Date().toLocaleString()}`);
  csv.push(`Salary: ¬£${document.getElementById('salary').value || '0'}`);
  csv.push('');

  monthsData.forEach(month => {
    csv.push(`Month: ${month.name}`);
    csv.push('='.repeat(50));

    if ((month.coreBills || []).length > 0) {
      csv.push('Core Bills');
      csv.push('Date,Payment Method,Company,Amount,Payment Type,Paid Status');
      month.coreBills.forEach(bill => {
        csv.push([
          bill.date, bill.method, bill.company, bill.amount, bill.type, bill.paid
        ].map(c => `"${String(c ?? '').replace(/"/g,'""')}"`).join(','));
      });
      csv.push('');
    }

    if ((month.overdraftEntries || []).length > 0) {
      csv.push('Overdraft, BNPL, Finance Plan, Debt Tracking');
      csv.push('Date,Payment Method,Bank/Company,Amount,Payment Type,Current Balance,Outstanding Balance,Limit,Paid Status');
      month.overdraftEntries.forEach(entry => {
        csv.push([
          entry.date, entry.method, entry.company, entry.amount, entry.type,
          entry.currentBalance, entry.outstandingBalance, entry.limit, entry.paid
        ].map(c => `"${String(c ?? '').replace(/"/g,'""')}"`).join(','));
      });
    }

    csv.push('\n\n');
  });

  downloadCSV(csv.join('\n'), `financial_tracker_all_data_${new Date().toISOString().split('T')[0]}.csv`);
  showNotification('All data exported to CSV', 'success');
}

function downloadCSV(data, filename) {
  const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/* =========================
   PDF EXPORT (FIXED)
   - safe parsing
   - includes Payment Method columns
   ========================= */
function exportPDF() {
  // save latest DOM first
  saveAll();

  if (monthsData.length === 0) {
    showNotification('No data to export', 'error');
    return;
  }

  if (!window.jspdf || !window.jspdf.jsPDF) {
    showNotification('PDF library failed to load. Check your internet/CDN.', 'error');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(20);
  doc.setTextColor(37, 99, 235);
  doc.text('Financial Tracker Report', 20, 20);

  doc.setFontSize(11);
  doc.setTextColor(100);
  doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
  doc.text(`Monthly Salary: ¬£${n(document.getElementById('salary').value).toFixed(2)}`, 20, 36);

  let yPos = 45;

  monthsData.forEach((month, index) => {
    if (index > 0) {
      doc.addPage();
      yPos = 20;
    }

    doc.setFontSize(16);
    doc.setTextColor(0);
    doc.text(String(month.name || 'Month'), 20, yPos);
    yPos += 10;

    // Core Bills
    const coreRows = [];
    (month.coreBills || []).forEach(bill => {
      const hasAny = (bill.date || bill.company || n(bill.amount) !== 0 || bill.type || bill.method);
      if (!hasAny) return;
      coreRows.push([
        bill.date || '',
        bill.method || '',
        bill.company || '',
        `¬£${n(bill.amount).toFixed(2)}`,
        bill.type || '',
        bill.paid === 'paid' ? '‚úì' : '‚úó'
      ]);
    });

    if (coreRows.length > 0) {
      doc.setFontSize(12);
      doc.setTextColor(50, 50, 50);
      doc.text('Core Bills', 20, yPos);
      yPos += 8;

      doc.autoTable({
        head: [['Date', 'Method', 'Company', 'Amount', 'Type', 'Paid']],
        body: coreRows,
        startY: yPos,
        theme: 'grid',
        headStyles: { fillColor: [37, 99, 235] },
        margin: { left: 20, right: 20 },
        styles: { fontSize: 9 }
      });
      yPos = doc.lastAutoTable.finalY + 12;
    }

    // Overdraft / Debt
    const debtRows = [];
    (month.overdraftEntries || []).forEach(entry => {
      const hasAny = (entry.date || entry.company || n(entry.amount) !== 0 || entry.type || entry.method ||
                      entry.currentBalance || entry.outstandingBalance || entry.limit);
      if (!hasAny) return;

      debtRows.push([
        entry.date || '',
        entry.method || '',
        entry.company || '',
        `¬£${n(entry.amount).toFixed(2)}`,
        entry.type || '',
        entry.currentBalance ? `¬£${n(entry.currentBalance).toFixed(2)}` : '',
        entry.outstandingBalance ? `¬£${n(entry.outstandingBalance).toFixed(2)}` : '',
        entry.limit ? `¬£${n(entry.limit).toFixed(2)}` : '',
        entry.paid === 'paid' ? '‚úì' : '‚úó'
      ]);
    });

    if (debtRows.length > 0) {
      doc.setFontSize(12);
      doc.setTextColor(50, 50, 50);
      doc.text('Overdraft / BNPL / Finance Plan / Debt', 20, yPos);
      yPos += 8;

      doc.autoTable({
        head: [['Date', 'Method', 'Company', 'Amount', 'Type', 'Current', 'Outstanding', 'Limit', 'Paid']],
        body: debtRows,
        startY: yPos,
        theme: 'grid',
        headStyles: { fillColor: [37, 99, 235] },
        margin: { left: 20, right: 20 },
        styles: { fontSize: 8 }
      });
      yPos = doc.lastAutoTable.finalY + 12;
    }

    const coreTotal = (month.coreBills || []).reduce((sum, b) => sum + n(b.amount), 0);
    const debtTotal = (month.overdraftEntries || []).reduce((sum, e) => sum + n(e.amount), 0);
    const salary = n(document.getElementById('salary').value);
    const remaining = salary - coreTotal - debtTotal;

    doc.setFontSize(12);
    doc.setTextColor(0);
    doc.text('Summary:', 20, yPos);
    yPos += 7;
    doc.setFontSize(10);
    doc.text(`Total Core Bills: ¬£${coreTotal.toFixed(2)}`, 25, yPos); yPos += 5;
    doc.text(`Total Overdraft/Debt: ¬£${debtTotal.toFixed(2)}`, 25, yPos); yPos += 5;
    doc.text(`Remaining Salary: ¬£${remaining.toFixed(2)}`, 25, yPos); yPos += 10;
  });

  doc.save(`financial_tracker_report_${new Date().toISOString().split('T')[0]}.pdf`);
  showNotification('PDF exported successfully', 'success');
}

/* =========================
   AUTO-SAVE + UNLOAD SAVE
   ========================= */
setInterval(() => {
  // avoid saving if no months (keeps storage clean)
  if (monthsData.length > 0) saveAll();
}, 30000);

window.addEventListener('beforeunload', () => {
  try { saveAll(); } catch {}
});

/* =========================
   KEYBOARD SHORTCUTS
   ========================= */
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveAll();
    showNotification('Data saved', 'success');
  }
  if (e.key === 'Escape') {
    closeListManager();
    document.querySelector('.modal-overlay')?.remove();
  }
  if (e.key === 'ArrowLeft') prevMonth();
  else if (e.key === 'ArrowRight') nextMonth();
});

// DOM ready
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
